<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Chainsawspares Operations{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --nav-bg: #ffffff;
            --nav-border: #e5e7eb;
            --nav-pill: #eff6ff;
            --nav-pill-active: #dbeafe;
            --nav-pill-text: #1e3a8a;
            --nav-text: #1f2937;
            --nav-muted: #6b7280;
            --brand-accent: linear-gradient(120deg, #2563eb, #0ea5e9);
            --left-panel-width: 400px;
            --right-panel-width: 400px;
        }
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f7f9fc;
        }
        
        .top-bar {
            position: sticky;
            top: 0;
            z-index: 1000;
            display: flex;
            align-items: center;
            padding: 0.65rem 1.75rem;
            gap: 1.25rem;
            background: var(--nav-bg);
            border-bottom: 1px solid var(--nav-border);
            box-shadow: 0 4px 12px rgba(15, 23, 42, 0.08);
        }
        
        .brand {
            display: flex;
            align-items: center;
            gap: 0.85rem;
            text-decoration: none;
            color: var(--nav-text);
            min-width: 200px;
        }
        
        .brand-icon {
            width: 38px;
            height: 38px;
            border-radius: 12px;
            background: var(--brand-accent);
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            box-shadow: 0 6px 15px rgba(37, 99, 235, 0.35);
        }
        
        .brand-text {
            display: flex;
            flex-direction: column;
            line-height: 1.1;
        }
        
        .brand-title {
            font-weight: 700;
            font-size: 1rem;
        }
        
        .brand-tagline {
            font-size: 0.75rem;
            color: var(--nav-muted);
        }
        
        .nav-menu {
            display: flex;
            gap: 0.35rem;
            flex: 1;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .nav-menu .menu-item {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            text-decoration: none;
            color: var(--nav-text);
            font-weight: 500;
            padding: 0.45rem 0.95rem;
            border-radius: 999px;
            background-color: transparent;
            transition: all 0.2s ease;
            border: 1px solid transparent;
            box-shadow: 0 0 0 transparent;
        }
        
        .nav-menu .menu-item i {
            font-size: 0.9rem;
        }
        
        .nav-menu .menu-item:hover {
            background-color: var(--nav-pill);
            color: var(--nav-pill-text);
        }
        
        .nav-menu .menu-item.active {
            background-color: var(--nav-pill-active);
            color: var(--nav-pill-text);
            box-shadow: 0 4px 10px rgba(37, 99, 235, 0.18);
            border-color: rgba(37, 99, 235, 0.25);
        }
        
        .header-actions {
            display: flex;
            align-items: center;
            gap: 0.65rem;
        }
        
        .quick-action-btn {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            border: 1px solid var(--nav-border);
            background: #fff;
            color: var(--nav-text);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }
        
        .quick-action-btn:hover {
            border-color: #2563eb;
            color: #2563eb;
            box-shadow: 0 6px 16px rgba(37, 99, 235, 0.15);
        }
        
        .user-dropdown {
            position: relative;
        }
        
        .user-trigger {
            display: flex;
            align-items: center;
            gap: 0.65rem;
            border: 1px solid var(--nav-border);
            padding: 0.35rem 0.85rem;
            border-radius: 999px;
            background: #fff;
            cursor: pointer;
            min-width: 190px;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        
        .user-trigger:hover {
            border-color: #2563eb;
            box-shadow: 0 8px 18px rgba(37, 99, 235, 0.15);
        }
        
        .user-avatar {
            width: 34px;
            height: 34px;
            border-radius: 50%;
            background: var(--nav-pill);
            color: var(--nav-pill-text);
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            text-transform: uppercase;
        }
        
        .user-meta {
            display: flex;
            flex-direction: column;
            line-height: 1.1;
        }
        
        .user-name {
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .user-role {
            font-size: 0.7rem;
            color: var(--nav-muted);
        }
        
        .user-trigger .fa-chevron-down {
            font-size: 0.75rem;
            color: var(--nav-muted);
        }

        @media (max-width: 1100px) {
            .top-bar {
                flex-wrap: wrap;
                height: auto;
                padding: 0.5rem 1rem;
                gap: 0.75rem;
            }
            
            .brand {
                order: 1;
                width: 100%;
                justify-content: flex-start;
            }
            
            .nav-menu {
                order: 3;
            }
            
            .header-actions {
                order: 2;
                width: 100%;
                justify-content: space-between;
            }
            
            .user-dropdown {
                flex: 1;
                justify-content: flex-end;
            }
        }
        
        .user-dropdown-menu {
            position: absolute;
            right: 0;
            top: calc(100% + 0.5rem);
            background: #fff;
            border: 1px solid var(--nav-border);
            border-radius: 12px;
            min-width: 210px;
            box-shadow: 0 15px 35px rgba(15, 23, 42, 0.15);
            padding: 0.5rem 0;
            display: none;
            z-index: 1200;
        }
        
        .user-dropdown.open .user-dropdown-menu {
            display: block;
        }
        
        .user-dropdown-menu button,
        .user-dropdown-menu a {
            width: 100%;
            display: flex;
            align-items: center;
            gap: 0.6rem;
            padding: 0.55rem 1rem;
            background: transparent;
            border: none;
            text-align: left;
            font-size: 0.9rem;
            color: var(--nav-text);
            text-decoration: none;
        }
        
        .user-dropdown-menu button:hover,
        .user-dropdown-menu a:hover {
            background-color: var(--nav-pill);
            color: var(--nav-pill-text);
        }
        
        .user-dropdown-menu .dropdown-divider {
            height: 1px;
            background: var(--nav-border);
            margin: 0.35rem 0;
        }
        
        .left-panel {
            position: fixed;
            top: 60px;
            left: 0;
            width: var(--left-panel-width);
            min-width: 300px;
            max-width: 600px;
            height: calc(100vh - 60px);
            background: linear-gradient(165deg, #1b263b, #0f1f34);
            color: #f8fafc;
            overflow-y: auto;
            z-index: 998;
            padding: 24px 20px 20px;
            border-right: 1px solid rgba(148, 163, 184, 0.15);
            box-shadow: 6px 0 24px rgba(15, 23, 42, 0.25);
            transition: width 0.2s ease, transform 0.3s ease;
        }
        
        /* Hide left panel by sliding it out */
        .left-panel.hidden {
            transform: translateX(-100%);
        }
        
        .left-resize-handle {
            position: absolute;
            top: 0;
            right: 0;
            width: 4px;
            height: 100%;
            background-color: #2c3e50;
            cursor: col-resize;
            z-index: 999;
            transition: background-color 0.2s ease;
        }
        
        .left-resize-handle:hover {
            background-color: #3498db;
        }
        
        .main-content {
            margin-left: var(--left-panel-width);
            margin-top: 0;
            padding: 32px 28px 28px;
            min-height: calc(100vh - 60px);
            transition: margin-left 0.3s ease;
        }
        
        /* When left panel is hidden, expand main content to full width */
        .main-content.left-panel-hidden {
            margin-left: 0;
        }
        
        .right-panel {
            position: fixed;
            top: 60px;
            right: 0;
            width: var(--right-panel-width);
            min-width: 300px;
            max-width: 600px;
            height: calc(100vh - 60px);
            background: #fbfbfd;
            border-left: 1px solid #e5e7eb;
            padding: 24px 22px 28px;
            overflow-y: auto;
            z-index: 998;
            transition: width 0.2s ease, transform 0.3s ease;
            box-shadow: -6px 0 24px rgba(15, 23, 42, 0.12);
        }
        
        /* Hide right panel by sliding it out */
        .right-panel.hidden {
            transform: translateX(100%);
        }
        
        .resize-handle {
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background-color: #dee2e6;
            cursor: col-resize;
            z-index: 999;
            transition: background-color 0.2s ease;
        }
        
        .resize-handle:hover {
            background-color: #007bff;
        }
        
        .resize-handle:active {
            background-color: #0056b3;
        }
        
        .content-area {
            margin-right: var(--right-panel-width);
            box-sizing: border-box;
            overflow-x: auto; /* Add scrolling if content is too wide */
            transition: margin-right 0.3s ease;
        }
        
        /* When right panel is hidden, expand content area to full width */
        .content-area.right-panel-hidden {
            margin-right: 0;
        }
        
        /* Ensure all content within content-area respects the width constraint */
        .content-area > * {
            max-width: 100%;
            box-sizing: border-box;
        }
        
        /* Ensure tables and their wrappers respect content-area width */
        .content-area .card,
        .content-area .table-responsive {
            max-width: 100%;
            overflow-x: auto;
            box-sizing: border-box;
        }
        
        .content-area table {
            table-layout: auto;
            width: 100%;
            max-width: 100%;
        }
        
        .card {
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            border: 1px solid rgba(0, 0, 0, 0.125);
        }
        
        .btn-primary {
            background-color: #3498db;
            border-color: #3498db;
        }
        
        .btn-primary:hover {
            background-color: #2980b9;
            border-color: #2980b9;
        }
        
        .badge {
            font-size: 0.75rem;
        }
        
        @media (max-width: 1200px) {
            .top-bar {
                flex-wrap: wrap;
                gap: 0.75rem;
            }
            .nav-menu {
                justify-content: flex-start;
                width: 100%;
                overflow-x: auto;
                padding-bottom: 0.3rem;
            }
            .header-actions {
                margin-left: auto;
            }
        }
        
        @media (max-width: 768px) {
            .brand {
                min-width: unset;
            }
            .header-actions {
                width: 100%;
                justify-content: flex-end;
            }
            .nav-menu {
                order: 3;
            }
        }
        
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s;
            }
            
            .sidebar.show {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
                padding: 15px; /* Reduce padding on smaller screens */
            }
            
            .content-area {
                margin-right: 0;
            }
            
            .right-panel {
                display: none;
            }
            
            /* Make dashboard content use more width on smaller screens */
            .content-area .row {
                margin-left: -10px;
                margin-right: -10px;
            }
            
            .content-area .row > [class*='col-'] {
                padding-left: 10px;
                padding-right: 10px;
            }
        }
        
        /* Extra small screens - even more compact */
        @media (max-width: 576px) {
            .main-content {
                padding: 10px; /* Even less padding on very small screens */
            }
            
            .content-area .row {
                margin-left: -5px;
                margin-right: -5px;
            }
            
            .content-area .row > [class*='col-'] {
                padding-left: 5px;
                padding-right: 5px;
            }
        }
        
        /* Custom scrollbar styling for items table */
        .table-responsive::-webkit-scrollbar {
            width: 8px;
        }
        
        .table-responsive::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        .table-responsive::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        
        .table-responsive::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        /* Ensure table header stays visible when scrolling */
        .table-responsive table thead th {
            position: sticky;
            top: 0;
            background-color: #212529;
            z-index: 10;
        }
        
        .sortable {
            cursor: pointer;
            user-select: none;
        }
        
        .sortable:hover {
            background-color: rgba(0, 0, 0, 0.1) !important;
        }
        
        .sortable i {
            margin-left: 5px;
            opacity: 0.7;
        }
        
        .sortable:hover i {
            opacity: 1;
        }
        
        /* Modern Compact Table Styling */
        .table-modern {
            font-size: 0.875rem;
            margin-bottom: 0;
        }
        
        .table-modern th {
            font-size: 0.8rem;
            font-weight: 600;
            padding: 0.5rem 0.4rem;
            border-bottom: 2px solid #dee2e6;
            background-color: #f8f9fa;
            color: #495057;
        }
        
        .table-modern thead.sticky-top th {
            position: sticky;
            top: 0;
            z-index: 10;
            background-color: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
        }
        
        .table-modern td {
            padding: 0.4rem 0.4rem;
            vertical-align: middle;
            border-bottom: 1px solid #e9ecef;
        }
        
        .table-modern.table-striped tbody tr:hover {
            background-color: #e9ecef !important;
        }
        
        .table-modern tbody tr:hover {
            background-color: #e9ecef;
        }
        
        .table-modern tbody tr.non-clickable-row {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .table-modern tbody tr.non-clickable-row:hover {
            background-color: #e9ecef;
            opacity: 0.8;
        }
        
        /* Ensure alternating rows have proper colors */
        .table-modern.table-striped > tbody > tr:nth-of-type(odd) > * {
            background-color: #ffffff;
        }
        
        .table-modern.table-striped > tbody > tr:nth-of-type(even) > * {
            background-color: #f8f9fa;
        }

        
        /* Column Alignment */
        .text-center {
            text-align: center !important;
        }
        
        .text-end {
            text-align: right !important;
        }
        
        /* Numeric columns - center aligned */
        .numeric-column {
            text-align: center;
            font-family: 'Courier New', monospace;
            font-weight: 500;
        }
        
        /* Price/Cost columns - right aligned */
        .price-column {
            text-align: right;
            font-family: 'Courier New', monospace;
            font-weight: 500;
        }
        
        /* Compact badges */
        .badge {
            font-size: 0.7rem;
            padding: 0.25rem 0.4rem;
        }
        
        /* Compact table responsive wrapper */
        .table-responsive-modern {
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            overflow: hidden;
        }
        
        /* Item Details and Notes Styling */
        .item-summary-content {
            font-size: 0.875rem;
        }
        
        .item-summary-content .row {
            margin-bottom: 0.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #9ca3af;
        }
        
        .item-summary-content .row:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .item-summary-content .col-4 {
            font-weight: 600;
            color: #6c757d;
        }
        
        .item-summary-content .col-8 {
            color: #495057;
        }
        
        .notes-list {
            padding: 12px;
            max-height: calc(100vh - 220px);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 14px;
        }
        
        .item-info-panel {
            background: #f8fafc;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            padding: 12px;
        }
        
        .note-composer {
            background: #fdf4e7;
            border-left: 4px solid #f97316;
            border-radius: 14px;
        }
        
        .note-composer .card-body {
            background: transparent;
        }
        
        .note-composer .card-title,
        .note-composer textarea,
        .note-composer .btn {
            color: #9a3412;
        }
        
        .note-composer textarea {
            border: 1px solid rgba(249, 115, 22, 0.3);
        }
        
        .note-composer .badge {
            background: rgba(249, 115, 22, 0.2);
            color: #9a3412;
        }
        
        .note-composer .btn {
            background: #f97316;
            border-color: #f97316;
            color: #fff;
        }
        
        .note-composer .btn:hover {
            background: #ea580c;
            border-color: #ea580c;
        }
        
        .note-feed {
            background: #f5f3ff;
            border-left: 4px solid #7c3aed;
            border-radius: 14px;
        }
        
        .note-feed .card-title {
            color: #5b21b6;
            font-weight: 600;
        }
        
        .note-feed-list {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid #e0e7ff;
            border-radius: 12px;
            padding: 16px;
            max-height: 320px;
        }
        
        .note-item-card {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 14px;
            padding: 14px 16px;
            color: #1f2937;
            box-shadow: 0 8px 24px rgba(15, 23, 42, 0.08);
            transition: transform 0.2s ease, border-color 0.2s ease;
        }
        
        .note-item-card:hover {
            transform: translateY(-2px);
            border-color: rgba(59, 130, 246, 0.4);
        }
        
        .notes-list .note-item-card:nth-child(even) {
            background: #f8fafc;
        }
        
        .note-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .note-sku {
            font-size: 0.78rem;
            font-weight: 600;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            padding: 2px 10px;
            border-radius: 999px;
            background: rgba(37, 99, 235, 0.12);
            color: #1d4ed8;
        }
        
        .note-meta {
            font-size: 0.75rem;
            color: rgba(241, 245, 249, 0.8);
        }
        
        .note-body {
            font-size: 0.92rem;
            line-height: 1.45;
            color: #1f2937;
            margin: 0;
        }
        
        .note-footer {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            margin-top: 10px;
            color: #475569;
        }
        
        .note-delete-btn {
            background: rgba(248, 113, 113, 0.15);
            border: none;
            color: #b91c1c;
            cursor: pointer;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s ease, transform 0.2s ease;
        }
        
        .note-delete-btn:hover {
            background: rgba(248, 113, 113, 0.3);
            transform: scale(1.05);
        }
        
        .left-panel .note-item-card {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(148, 163, 184, 0.25);
            color: #f1f5f9;
            box-shadow: 0 10px 30px rgba(2, 6, 23, 0.45);
        }
        
        .left-panel .note-item-card:nth-child(even) {
            background: rgba(15, 23, 42, 0.7);
        }
        
        .left-panel .note-item-card .note-body {
            color: #e2e8f0;
        }
        
        .left-panel .note-item-card .note-footer {
            color: rgba(148, 163, 184, 0.85);
        }
        
        .left-panel .note-delete-btn {
            background: rgba(248, 113, 113, 0.2);
            color: #fecdd3;
        }
        
        .left-panel .note-sku {
            background: rgba(59, 130, 246, 0.25);
            color: #bfdbfe;
        }
        
        .notes-placeholder {
            color: rgba(209, 213, 219, 0.85);
            text-align: center;
            padding: 40px 20px;
        }
        
        .clickable-row {
            cursor: pointer;
        }
        
        .clickable-row:hover {
            background-color: #f8f9fa !important;
        }

        .alert-compact {
            padding: 6px 12px;
            font-size: 0.85rem;
            border-left: 4px solid #ff9800;
            background-color: #fff7e6;
            color: #7a4f00;
        }

        .flag-review-modal .item-meta-row {
            display: flex;
            justify-content: space-between;
            font-size: 0.92rem;
            margin-bottom: 0.35rem;
        }

        .flag-review-modal .item-meta-row span:first-child {
            color: #6b7280;
            font-weight: 600;
            margin-right: 1rem;
            min-width: 130px;
        }

        .flag-review-modal .badge-change-log {
            font-size: 0.82rem;
            padding: 0.25rem 0.65rem;
        }

        .flag-review-modal .review-comment {
            min-height: 110px;
            resize: vertical;
        }

        .flag-review-modal .modal-body {
            background: #f9fafb;
        }

        .warehouse-table thead th {
            font-weight: 600;
            font-size: 0.85rem;
            color: #4b5563;
            background: #f8fafc;
        }

        .warehouse-table tbody td {
            font-size: 0.9rem;
            font-weight: 400;
            color: #1f2937;
        }

        .warehouse-table tbody tr {
            vertical-align: middle;
            cursor: pointer;
        }

        .warehouse-table tbody tr:hover {
            background-color: #f3f4f6;
        }

        .warehouse-detail-meta span {
            display: inline-block;
            min-width: 140px;
            color: #6b7280;
            font-weight: 600;
        }

        .warehouse-detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
        }

        .warehouse-detail-grid .stat-card {
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            padding: 12px;
            background: #f9fafb;
        }
    </style>
</head>
<body>
    <!-- Top Bar -->
    <div class="top-bar">
        <a href="{{ url_for('dashboard') }}" class="brand">
            <div class="brand-icon">
                <i class="fas fa-chainsaw"></i>
            </div>
            <div class="brand-text">
                <span class="brand-title">Chainsawspares Ops</span>
                <span class="brand-tagline">Operations Control</span>
            </div>
        </a>
        {% if current_user.is_authenticated %}
        <nav class="nav-menu">
            <a href="{{ url_for('dashboard') }}" class="menu-item {% if request.endpoint == 'dashboard' %}active{% endif %}">
                <i class="fas fa-home"></i> Home
            </a>
            <a href="#" class="menu-item" onclick="loadContent('rex-po-orders', event)">
                <i class="fas fa-shopping-cart"></i> REX PO Orders
            </a>
            <a href="#" class="menu-item" onclick="loadContent('comparison', event)">
                <i class="fas fa-balance-scale"></i> Comparison
            </a>
            {% if current_user.is_authenticated and (current_user.role == 'retail' or current_user.role == 'admin') %}
            <a href="#" class="menu-item" onclick="loadContent('retail', event)">
                <i class="fas fa-user-check"></i> Retail
            </a>
            {% endif %}
            {% if current_user.is_authenticated and (current_user.role == 'warehouse' or current_user.role == 'admin') %}
            <a href="#" class="menu-item" onclick="loadContent('warehouse', event)">
                <i class="fas fa-warehouse"></i> Warehouse
            </a>
            {% endif %}
            <a href="#" class="menu-item" onclick="loadContent('cost-price-check', event)">
                <i class="fas fa-dollar-sign"></i> Cost Price Check
            </a>
            <a href="#" class="menu-item" onclick="loadContent('change-log-guide', event)">
                <i class="fas fa-info-circle"></i> Change Log Guide
            </a>
            {% if current_user.is_admin %}
            {% endif %}
        </nav>
        <div class="header-actions">
            <button class="quick-action-btn" type="button" onclick="refreshData()" title="Refresh data">
                <i class="fas fa-rotate"></i>
            </button>
            <button class="quick-action-btn" type="button" onclick="testConnection()" title="Test BigQuery connection">
                <i class="fas fa-plug"></i>
            </button>
            <div class="user-dropdown" id="userDropdown">
                <button class="user-trigger" type="button" onclick="toggleUserDropdown(event)">
                    <span class="user-avatar">{{ (current_user.username[:1] if current_user.username else 'U')|upper }}</span>
                    <span class="user-meta">
                        <span class="user-name">{{ current_user.username }}</span>
                        <span class="user-role">
                            {% if current_user.is_admin %}Admin{% else %}User{% endif %}
                        </span>
                    </span>
                    <i class="fas fa-chevron-down"></i>
                </button>
                <div class="user-dropdown-menu" id="userDropdownMenu">
                    <button type="button" onclick="refreshData()">
                        <i class="fas fa-sync-alt text-primary"></i> Refresh Data
                    </button>
                    <button type="button" onclick="testConnection()">
                        <i class="fas fa-satellite-dish text-success"></i> Test Connection
                    </button>
                    {% if current_user.is_admin %}
                    <a href="{{ url_for('admin') }}" class="{% if request.endpoint == 'admin' %}active{% endif %}">
                        <i class="fas fa-users-cog text-info"></i> User Management
                    </a>
                    <div class="dropdown-divider"></div>
                    {% endif %}
                    <a href="{{ url_for('logout') }}">
                        <i class="fas fa-sign-out-alt text-danger"></i> Logout
                    </a>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Flag Review Modal -->
    <div class="modal fade flag-review-modal" id="flagReviewModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-flag me-2 text-danger"></i>Flag Item for Warehouse Review</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <div class="item-meta-row"><span>PO ID</span><strong id="flagReviewPoId">-</strong></div>
                        <div class="item-meta-row"><span>SKU</span><strong id="flagReviewSku">-</strong></div>
                        <div class="item-meta-row"><span>Product</span><span id="flagReviewName">-</span></div>
                        <div class="item-meta-row">
                            <span>Change Log</span>
                            <span id="flagReviewChangeLog"></span>
                        </div>
                        <div class="item-meta-row"><span>Latest Note</span><span id="flagReviewLatestNote">-</span></div>
                    </div>
                    <div class="mb-3">
                        <label for="flagReviewComment" class="form-label">Optional comment</label>
                        <textarea id="flagReviewComment" class="form-control review-comment" maxlength="500" placeholder="Provide context for the Warehouse team (optional)..."></textarea>
                        <div class="d-flex justify-content-between mt-1">
                            <small class="text-muted">Comments help warehouse understand the issue faster.</small>
                            <small class="text-muted"><span id="flagReviewCharCount">0</span>/500</small>
                        </div>
                    </div>
                    <div class="alert alert-warning d-none" id="flagReviewWarning">
                        <i class="fas fa-info-circle me-1"></i><span class="message">This item is already flagged for review.</span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmFlagReviewBtn">
                        <span class="default-label"><i class="fas fa-flag me-1"></i>Flag Item</span>
                        <span class="loading-label d-none"><i class="fas fa-spinner fa-spin me-1"></i>Flagging...</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Warehouse Review Modal -->
    <div class="modal fade" id="warehouseReviewModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-warehouse me-2"></i>Warehouse Review Detail</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-4">
                        <div class="col-lg-6">
                            <div class="warehouse-detail-meta mb-3">
                                <div><span>PO ID:</span> <strong id="warehouseDetailPoId">-</strong></div>
                                <div><span>Order ID:</span> <strong id="warehouseDetailOrderId">-</strong></div>
                                <div><span>Item ID:</span> <strong id="warehouseDetailItemId">-</strong></div>
                                <div><span>SKU:</span> <strong id="warehouseDetailSku">-</strong></div>
                                <div><span>Product:</span> <span id="warehouseDetailProduct">-</span></div>
                                <div><span>Change Log:</span> <span id="warehouseDetailChange"></span></div>
                                <div><span>Flagged By:</span> <span id="warehouseDetailFlaggedBy">-</span></div>
                                <div><span>Flagged At:</span> <span id="warehouseDetailFlaggedAt">-</span></div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Retail Comment</label>
                                <div class="border rounded p-2 bg-light" id="warehouseDetailRetailComment">-</div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Latest Note</label>
                                <div class="border rounded p-2 bg-light" id="warehouseDetailLatestNote">-</div>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="warehouse-detail-grid mb-3" id="warehouseDetailStats"></div>
                            <div class="mb-3">
                                <label for="warehouseCommentInput" class="form-label">Warehouse Comment</label>
                                <textarea id="warehouseCommentInput" class="form-control" rows="3" placeholder="Describe the fix or action taken..."></textarea>
                            </div>
                            <div class="alert alert-warning d-none" id="warehouseDetailWarning"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" id="warehouseCloseBtn">
                        <span class="default-label"><i class="fas fa-check me-1"></i>Mark as Completed</span>
                        <span class="loading-label d-none"><i class="fas fa-spinner fa-spin me-1"></i>Updating...</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade retail-review-modal" id="retailReviewModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-user-check me-2 text-primary"></i>Retail Review Detail</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning d-none mb-3" id="retailModalInfo"></div>
                    <div class="row g-4">
                        <div class="col-lg-5">
                            <div class="warehouse-detail-meta mb-3">
                                <div><span>Review ID:</span> <strong id="retailDetailReviewId">-</strong></div>
                                <div><span>PO ID:</span> <strong id="retailDetailPoId">-</strong></div>
                                <div><span>Order ID:</span> <strong id="retailDetailOrderId">-</strong></div>
                                <div><span>Item ID:</span> <strong id="retailDetailItemId">-</strong></div>
                                <div><span>SKU:</span> <strong id="retailDetailSku">-</strong></div>
                                <div><span>Item:</span> <span id="retailDetailProduct">-</span></div>
                                <div><span>Change Log:</span> <span id="retailDetailChange"></span></div>
                                <div><span>Status:</span> <span id="retailDetailStatus"></span></div>
                                <div><span>Flagged By:</span> <span id="retailDetailFlaggedBy">-</span></div>
                                <div><span>Flagged At:</span> <span id="retailDetailFlaggedAt">-</span></div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Retail Flag Comment</label>
                                <div class="border rounded p-2 bg-light" id="retailDetailFlagComment">-</div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Latest Item Note</label>
                                <div class="border rounded p-2 bg-light" id="retailDetailLatestNote">-</div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Warehouse Response</label>
                                <div class="border rounded p-3 bg-white shadow-sm">
                                    <div id="retailWarehouseComment" class="text-dark mb-2">Warehouse has not provided feedback yet.</div>
                                    <div class="small text-muted" id="retailWarehouseMeta"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-7">
                            <div class="warehouse-detail-grid mb-3" id="retailDetailStats"></div>
                            <div class="mb-3">
                                <label class="form-label">Retail Resolution</label>
                                <textarea id="retailResolutionComment" class="form-control review-comment" rows="4" maxlength="500" placeholder="Add optional notes before marking this review as resolved..."></textarea>
                                <div class="d-flex justify-content-between mt-1">
                                    <small class="text-muted">Optional note saved with your resolution.</small>
                                    <small class="text-muted"><span id="retailCommentCharCount">0</span>/500</small>
                                </div>
                            </div>
                            <div class="alert alert-success d-none" id="retailResolvedMeta"></div>
                            <div class="alert alert-danger d-none" id="retailDetailWarning"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary d-none" id="retailResolveBtn">
                        <span class="default-label"><i class="fas fa-check-double me-1"></i>Mark as Resolved</span>
                        <span class="loading-label d-none"><i class="fas fa-spinner fa-spin me-1"></i>Saving...</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Left Panel (All Item Notes) -->
    {% if current_user.is_authenticated %}
    <div class="left-panel hidden" id="allItemNotesCard">
        <div class="left-resize-handle"></div>
        <div id="leftPanelContent">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 style="color: #fff; margin-bottom: 0;">
                    <i class="fas fa-list me-2"></i>All Item Notes 
                    <span id="all-item-notes-count" class="badge bg-primary ms-2">0</span>
                </h5>
            </div>
            <!-- PO Info inline (hidden until PO selected) -->
            <div id="po-info-inline" class="mb-3 item-info-panel" style="display: none; background: rgba(15, 23, 42, 0.7); color: #cfd8e3;">
                <!-- PO ID and Order ID will be populated here -->
            </div>
            <div id="all-item-notes-list" class="notes-list">
                <div class="notes-placeholder">
                    <i class="fas fa-sticky-note fa-3x mb-3" style="opacity: 0.25;"></i>
                    <p class="mb-0">Select a purchase order from the summary table to view all item notes.</p>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Main Content Area -->
    <div class="main-content left-panel-hidden">
        <div class="content-area right-panel-hidden">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}

            {% block content %}{% endblock %}
        </div>
    </div>

    <!-- Right Panel -->
    {% if current_user.is_authenticated %}
    <div class="right-panel hidden" id="right-panel">
        <div class="resize-handle" id="resize-handle"></div>
        <!-- Default Quick Info Panel -->
        <div id="quick-info-panel">
            <h6 class="text-muted mb-3">Quick Info</h6>
            
            <!-- Cache Status Card -->
            <div class="card mb-3">
                <div class="card-body">
                    <h6 class="card-title">
                        <i class="fas fa-database me-2"></i>Data Cache
                    </h6>
                    <div id="sidebarCacheStatus">
                        <div class="text-center">
                            <div class="spinner-border spinner-border-sm text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <small class="d-block mt-1">Loading...</small>
                        </div>
                    </div>
                    <div class="d-grid gap-2 mt-2" style="display: none;" id="sidebarCacheButtons">
                        <button id="sidebarRefreshBtn" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                        <button id="sidebarClearBtn" class="btn btn-outline-danger btn-sm">
                            <i class="fas fa-trash"></i> Clear Cache
                        </button>
                    </div>
                </div>
            </div>
        </div>
        

            <!-- Item Details Panel (hidden by default) -->
            <div id="item-details-panel" style="display: none;">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="text-muted mb-0"><i class="fas fa-sticky-note me-2"></i>Add Item Note</h6>
                    <button class="btn btn-sm btn-outline-secondary" onclick="closeItemDetails()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <!-- Item Info Header -->
                <div id="item-info-header" class="mb-3 item-info-panel">
                    <!-- PO ID, SKU, and Product Name will be populated here -->
                </div>
                
                <!-- Add Note Input Section (Top) -->
                <div class="card note-composer mb-3">
                    <div class="card-body">
                        <h6 class="card-title mb-2 d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-edit me-2"></i>Add Comment</span>
                            <span id="item-sku-badge" class="badge"></span>
                        </h6>
                        <textarea id="new-note" class="form-control mb-2" rows="3" placeholder="Add a comment..."></textarea>
                        <button class="btn btn-sm btn-primary w-100" onclick="saveNote()">
                            <i class="fas fa-save"></i> Save Note
                        </button>
                    </div>
                </div>
                
                <!-- All Notes Section (Bottom - Scrollable) -->
                <div class="card note-feed">
                    <div class="card-body">
                        <h6 class="card-title mb-2"><i class="fas fa-list me-2"></i>All Notes for this Item</h6>
                        <div id="notes-list" class="notes-list note-feed-list">
                            <div class="text-center text-muted">
                                <small>No notes yet for this item.</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
    </div>
    {% endif %}

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function loadContent(contentType, event) {
            const contentArea = document.querySelector('.content-area');
            const quickInfoPanel = document.getElementById('quick-info-panel');
            
            if (contentType === 'rex-po-orders') {
                // Show left panel and hide right panel
                showLeftPanel();
                hideRightPanel(); // Hide right panel with proper class management (inline styles cleared automatically)
                resetNotesPanels();
                
                // Update active menu item
                document.querySelectorAll('.menu-item').forEach(item => {
                    item.classList.remove('active');
                });
                if (event && event.target) {
                    event.target.classList.add('active');
                }
                
                // Load BigQuery data content
                contentArea.innerHTML = `
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                            <h2><i class="fas fa-shopping-cart"></i> Purchase Orders</h2>
                            <div class="alert alert-warning alert-compact mb-0">
                                <i class="fas fa-exclamation-triangle me-2"></i>Use the header refresh/test buttons whenever you open this page to pull the latest data.
                            </div>
                        </div>
                        <div class="d-flex justify-content-end mt-2">
                            <div id="lastRefreshTimestamp" class="text-muted" style="font-size: 0.875rem;">
                                <i class="fas fa-clock me-1"></i>
                                <span id="timestampText">Loading...</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Search and Filter -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="searchInput" placeholder="Enter PO ID or Order ID...">
                                        <button class="btn btn-outline-secondary" type="button" id="clearMainSearchBtn">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="skuSearchInput" placeholder="Enter SKU or Manufacturer SKU..." title="Search by SKU or Manufacturer SKU">
                                        <button class="btn btn-outline-primary" type="button" id="skuSearchBtn">
                                            <i class="fas fa-search"></i>
                                        </button>
                                        <button class="btn btn-outline-secondary" type="button" id="clearSkuSearchBtn">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-4 d-flex align-items-end">
                                    <button id="searchBtn" class="btn btn-outline-primary me-2">
                                        <i class="fas fa-search"></i> Search
                                    </button>
                                    <button id="clearAllSearchBtn" class="btn btn-outline-secondary">
                                        <i class="fas fa-eraser"></i> Clear All
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Connection Status -->
                    <div id="connectionStatus" class="alert alert-info" style="display: none;">
                        <i class="fas fa-info-circle"></i> <span id="connectionMessage"></span>
                    </div>
                    
                    <!-- Loading Spinner -->
                    <div id="loadingSpinner" class="text-center" style="display: none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading data from BigQuery...</p>
                    </div>
                    
                    <!-- Summary Table -->
                    <div class="card mb-4" style="background-color: #ffffff; height: calc(100vh - 200px);">
                        <div class="card-header" style="background-color: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                            <h5><i class="fas fa-list-alt"></i> Purchase Orders</h5>
                        </div>
                        <div class="card-body" style="background-color: #ffffff; height: 100%; overflow-y: auto; padding: 0;">
                            <div id="summaryContainer" style="height: 100%;">
                                <div class="text-center text-muted" style="padding-top: 100px;">
                                    <i class="fas fa-database fa-3x mb-3"></i>
                                    <p>Click "Refresh Data" to load purchase order summary from BigQuery</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Pagination -->
                    <nav id="paginationNav" style="display: none;">
                        <ul class="pagination justify-content-center">
                            <li class="page-item" id="prevPage">
                                <a class="page-link" href="#" onclick="changePage(-1)">Previous</a>
                            </li>
                            <li class="page-item active" id="currentPage">
                                <span class="page-link">1</span>
                            </li>
                            <li class="page-item" id="nextPage">
                                <a class="page-link" href="#" onclick="changePage(1)">Next</a>
                            </li>
                        </ul>
                    </nav>
                    
                    <!-- Data Info -->
                    <div id="dataInfo" class="mt-3" style="display: none;">
                        <small class="text-muted">
                            <i class="fas fa-info-circle"></i>
                            <span id="dataCount"></span> records loaded at <span id="dataTimestamp"></span>
                        </small>
                    </div>
                `;
                
                // Initialize the BigQuery functionality
                initializeBigQueryPage();
            } else if (contentType === 'cost-price-check') {
                // Show left panel and hide right panel
                showLeftPanel();
                hideRightPanel(); // Hide right panel with proper class management (inline styles cleared automatically)
                
                // Update active menu item
                document.querySelectorAll('.menu-item').forEach(item => {
                    item.classList.remove('active');
                });
                if (event && event.target) {
                    event.target.classList.add('active');
                }
                
                // Load Cost Price Check content
                contentArea.innerHTML = `
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                            <h2><i class="fas fa-dollar-sign"></i> Cost Price Check</h2>
                            <div class="alert alert-warning alert-compact mb-0">
                                <i class="fas fa-exclamation-triangle me-2"></i>Need fresh numbers? Use the header buttons to refresh data or test the connection.
                            </div>
                        </div>
                        <div class="d-flex justify-content-end mt-2">
                            <div id="lastRefreshTimestamp" class="text-muted" style="font-size: 0.875rem;">
                                <i class="fas fa-clock me-1"></i>
                                <span id="timestampText">Loading...</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Search and Filter -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-5">
                                    <label class="form-label"><strong>Search by PO ID</strong></label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="costPricePoSearch" placeholder="Enter PO ID...">
                                        <button class="btn btn-primary" type="button" id="costPricePoSearchBtn">
                                            <i class="fas fa-search"></i> Search
                                        </button>
                                        <button class="btn btn-outline-secondary" type="button" id="costPriceClearPoSearchBtn">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-2 d-flex align-items-end justify-content-center">
                                    <span class="text-muted">OR</span>
                                </div>
                                <div class="col-md-5">
                                    <label class="form-label"><strong>Search by SKU</strong></label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="costPriceSkuSearch" placeholder="Enter SKU or Manufacturer SKU...">
                                        <button class="btn btn-primary" type="button" id="costPriceSkuSearchBtn">
                                            <i class="fas fa-search"></i> Search
                                        </button>
                                        <button class="btn btn-outline-secondary" type="button" id="costPriceClearSkuSearchBtn">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Loading Spinner -->
                    <div id="costPriceLoadingSpinner" class="text-center" style="display: none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading cost price data...</p>
                    </div>
                    
                    <!-- Items Table -->
                    <div class="card mb-4" id="costPriceItemsCard" style="display: none; background-color: #f0f8ff;">
                        <div class="card-header" style="background-color: #e3f2fd; border-bottom: 1px solid #bbdefb;">
                            <h5><i class="fas fa-dollar-sign"></i> Cost Price Check Results <span class="badge bg-secondary ms-2" style="font-size: 0.9em;" id="costPriceCount">0</span></h5>
                        </div>
                        <div class="card-body" style="background-color: #f0f8ff;">
                            <div id="costPriceItemsContainer">
                                <div class="text-center text-muted">
                                    <i class="fas fa-search fa-3x mb-3"></i>
                                    <p>Search by PO ID, Order ID, or SKU to view cost price data</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Initialize the Cost Price Check functionality
                initializeCostPriceCheckPage();
            } else if (contentType === 'comparison') {
                // Show left panel and hide right panel
                showLeftPanel();
                hideRightPanel(); // Hide right panel with proper class management (inline styles cleared automatically)
                
                // Update active menu item
                document.querySelectorAll('.menu-item').forEach(item => {
                    item.classList.remove('active');
                });
                if (event && event.target) {
                    event.target.classList.add('active');
                }
                
                // Load Comparison content
                contentArea.innerHTML = `
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                            <h2><i class="fas fa-balance-scale"></i> Comparison</h2>
                            <div class="alert alert-warning alert-compact mb-0">
                                <i class="fas fa-exclamation-triangle me-2"></i>Need fresh comparison data? Use the header controls to refresh or test BigQuery.
                            </div>
                        </div>
                        <div class="d-flex justify-content-end mt-2">
                            <div id="lastRefreshTimestamp" class="text-muted" style="font-size: 0.875rem;">
                                <i class="fas fa-clock me-1"></i>
                                <span id="timestampText">Loading...</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Comparison Table -->
                    <div class="card" id="comparisonCard" style="background-color: #ffffff; height: calc(100vh - 200px);">
                        <div class="card-header" style="background-color: #f8f9fa; border-bottom: 2px solid #dee2e6; display: none;">
                            <span id="comparisonCount" class="badge bg-secondary">0</span>
                        </div>
                        <div class="card-body" style="background-color: #ffffff; height: 100%; overflow-y: auto; padding: 0;">
                            <div id="comparisonContainer" style="height: 100%;">
                                <div class="text-center text-muted" style="padding-top: 100px;">
                                    <i class="fas fa-balance-scale fa-3x mb-3"></i>
                                    <p>Select a purchase order from the REX PO Orders Summary table to view comparison data</p>
                                    <p class="text-secondary"><small>Or the comparison data will appear here when you search by SKU</small></p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Initialize the Comparison page functionality
                initializeComparisonPage();
            } else if (contentType === 'retail') {
                showLeftPanel();
                hideRightPanel();
                
                document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
                if (event && event.target) {
                    event.target.closest('.menu-item').classList.add('active');
                }
                
                contentArea.innerHTML = `
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                            <h2><i class="fas fa-user-check"></i> Retail Reviews</h2>
                            <div class="alert alert-info alert-compact mb-0">
                                <i class="fas fa-info-circle me-2"></i>Warehouse-completed items appear first. Pending warehouse items remain in the queue below.
                            </div>
                        </div>
                    </div>
                    <div id="retailReviewsContainer">
                        <div class="text-center text-muted py-5" id="retailReviewsLoading">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2 mb-0">Loading retail review queue...</p>
                        </div>
                    </div>
                `;
                
                initializeRetailPage();
            } else if (contentType === 'warehouse') {
                showLeftPanel();
                hideRightPanel();
                
                document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
                if (event && event.target) {
                    event.target.closest('.menu-item').classList.add('active');
                }
                
                contentArea.innerHTML = `
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                            <h2><i class="fas fa-warehouse"></i> Warehouse Reviews</h2>
                            <div class="alert alert-warning alert-compact mb-0">
                                <i class="fas fa-info-circle me-2"></i>Newly flagged items appear first. Closed reviews are shown for quick reference.
                            </div>
                        </div>
                    </div>
                    <div id="warehouseReviewsContainer">
                        <div class="text-center text-muted py-5" id="warehouseReviewsLoading">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2 mb-0">Loading warehouse reviews...</p>
                        </div>
                    </div>
                `;
                
                initializeWarehousePage();
            } else if (contentType === 'change-log-guide') {
                // Hide both panels for full-width guide
                hideLeftPanel();
                hideRightPanel();
                
                // Make content area full width
                contentArea.style.marginLeft = '0';
                contentArea.style.marginRight = '0';
                contentArea.style.width = '100%';
                
                // Update active menu item
                document.querySelectorAll('.menu-item').forEach(item => {
                    item.classList.remove('active');
                });
                if (event && event.target) {
                    event.target.closest('.menu-item').classList.add('active');
                }
                
                // Load Change Log Guide content
                contentArea.innerHTML = `
                    <div class="container-fluid">
                        <div class="mb-4">
                            <h2><i class="fas fa-info-circle"></i> Change Log Guide</h2>
                            <p class="text-muted">Understanding the different change types in the Comparison table</p>
                        </div>
                        
                        <div class="row">
                            <div class="col-12">
                                <div class="card shadow-sm mb-4">
                                    <div class="card-body">
                                        <h4 class="mb-4">Change Types Reference</h4>
                                        
                                        <!-- Timing Information -->
                                        <div class="alert alert-info mb-4">
                                            <h5 class="alert-heading"><i class="fas fa-clock"></i> Timing Context</h5>
                                            <p class="mb-2">Change types are evaluated at different stages of the order lifecycle:</p>
                                            <ul class="mb-0">
                                                <li><strong>After NETO dispatch but before REX receival:</strong> Items are in transit or awaiting receival</li>
                                                <li><strong>After invoice has been received into REX:</strong> Items have been physically received and quantities updated</li>
                                            </ul>
                                        </div>
                                        
                                        <!-- Custom CSS for lighter table borders -->
                                        <style>
                                            .changelog-table {
                                                border-color: #dee2e6 !important;
                                            }
                                            .changelog-table th,
                                            .changelog-table td {
                                                border-color: #e9ecef !important;
                                            }
                                            .changelog-table thead {
                                                border-bottom: 2px solid #e0e0e0 !important;
                                            }
                                            .changelog-table thead th {
                                                border-bottom-color: #e0e0e0 !important;
                                            }
                                        </style>
                                        
                                        <!-- Two Column Layout -->
                                        <div class="row">
                                            <!-- Left Column: Before Receival -->
                                            <div class="col-md-6">
                                                <h4 class="mb-3 text-primary"><i class="fas fa-shipping-fast"></i> After NETO dispatch but before REX receival</h4>
                                                
                                                <!-- Quantity Changed (Before Receival) -->
                                                <div class="card mb-3 border-info">
                                                    <div class="card-header bg-info bg-opacity-10">
                                                        <h5 class="mb-0"><span class="badge bg-info text-dark">Quantity Changed</span></h5>
                                                    </div>
                                                    <div class="card-body">
                                                        <p class="mb-2"><strong>Condition:</strong> Rex Qty Ordered  NETO qty invoiced</p>
                                                        <p class="mb-2"><strong>Description:</strong> The warehouse has invoiced a different quantity than what was originally ordered. Add a note explaining this quantity change.</p>
                                                        <table class="table table-sm table-bordered changelog-table mb-0">
                                                            <thead class="table-light">
                                                                <tr>
                                                                    <th>Rex Qty Ordered</th>
                                                                    <th>NETO qty invoiced</th>
                                                                    <th>Rex Qty Received</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                <tr>
                                                                    <td>5</td>
                                                                    <td>3</td>
                                                                    <td>-</td>
                                                                </tr>
                                                            </tbody>
                                                        </table>
                                                        <div class="mt-2 p-2 bg-light border-start border-info border-3">
                                                            <small><strong>Result:</strong> 5 items were ordered in REX but only 3 are invoiced in NETO. This could be due to shortage of stock, warehouse unable to fulfill the full quantity, or partial availability. The warehouse has reduced the order quantity.</small>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <!-- Item Removed -->
                                                <div class="card mb-3 border-danger">
                                                    <div class="card-header bg-danger bg-opacity-10">
                                                        <h5 class="mb-0"><span class="badge bg-danger">Item Removed</span></h5>
                                                    </div>
                                                    <div class="card-body">
                                                        <p class="mb-2"><strong>Condition:</strong> Item ordered in REX but not present on NETO invoice</p>
                                                        <p class="mb-2"><strong>Description:</strong> This item was ordered but has been completely removed from the invoice (not backordered). Usually indicates the item was out of stock or unavailable. Add a note explaining the removal.</p>
                                                        <table class="table table-sm table-bordered changelog-table mb-0">
                                                            <thead class="table-light">
                                                                <tr>
                                                                    <th>Rex Qty Ordered</th>
                                                                    <th>NETO qty invoiced</th>
                                                                    <th>Rex Qty Received</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                <tr>
                                                                    <td>4</td>
                                                                    <td>-</td>
                                                                    <td>-</td>
                                                                </tr>
                                                            </tbody>
                                                        </table>
                                                        <div class="mt-2 p-2 bg-light border-start border-danger border-3">
                                                            <small><strong>Result:</strong> 4 items were ordered in REX but the item doesn't appear on the NETO invoice at all. The warehouse has completely removed this item from the order, likely due to stock unavailability or discontinuation.</small>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <!-- Back Ordered -->
                                                <div class="card mb-3 border-dark">
                                                    <div class="card-header bg-dark bg-opacity-10">
                                                        <h5 class="mb-0"><span class="badge bg-dark">Back Ordered</span></h5>
                                                    </div>
                                                    <div class="card-body">
                                                        <p class="mb-2"><strong>Condition:</strong> NETO qty invoiced = 0 AND item appears on NETO backorder</p>
                                                        <p class="mb-2"><strong>Description:</strong> This item was ordered but is currently out of stock with the warehouse. It has been placed on backorder and will be shipped when stock becomes available. Add a note indicating the item is backordered.</p>
                                                        <table class="table table-sm table-bordered changelog-table mb-0">
                                                            <thead class="table-light">
                                                                <tr>
                                                                    <th>Rex Qty Ordered</th>
                                                                    <th>NETO qty invoiced</th>
                                                                    <th>Rex Qty Received</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                <tr>
                                                                    <td>5</td>
                                                                    <td>0</td>
                                                                    <td>-</td>
                                                                </tr>
                                                            </tbody>
                                                        </table>
                                                        <div class="mt-2 p-2 bg-light border-start border-dark border-3">
                                                            <small><strong>Result:</strong> 5 items were ordered in REX but the invoice shows 0 quantity and the item appears on the NETO backorder list. The warehouse is temporarily out of stock but will fulfill this order once inventory is replenished.</small>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <!-- No Change (Before Receival) -->
                                                <div class="card mb-3 border-secondary">
                                                    <div class="card-header bg-light">
                                                        <h5 class="mb-0"><span class="badge bg-light text-dark">No Change</span></h5>
                                                    </div>
                                                    <div class="card-body">
                                                        <p class="mb-2"><strong>Condition:</strong> Rex Qty Ordered = NETO qty invoiced</p>
                                                        <p class="mb-2"><strong>Description:</strong> Perfect! The ordered quantity matches the invoiced quantity. Everything is as expected and no action is required.</p>
                                                        <table class="table table-sm table-bordered changelog-table mb-0">
                                                            <thead class="table-light">
                                                                <tr>
                                                                    <th>Rex Qty Ordered</th>
                                                                    <th>NETO qty invoiced</th>
                                                                    <th>Rex Qty Received</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                <tr>
                                                                    <td>6</td>
                                                                    <td>6</td>
                                                                    <td>-</td>
                                                                </tr>
                                                            </tbody>
                                                        </table>
                                                        <div class="mt-2 p-2 bg-light border-start border-secondary border-3">
                                                            <small><strong>Result:</strong> 6 items were ordered in REX and 6 items are invoiced in NETO. Perfect match! The order is proceeding exactly as planned with no discrepancies.</small>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <!-- New Item -->
                                                <div class="card mb-3 border-success">
                                                    <div class="card-header bg-success bg-opacity-10">
                                                        <h5 class="mb-0"><span class="badge bg-success">New Item</span></h5>
                                                    </div>
                                                    <div class="card-body">
                                                        <p class="mb-2"><strong>Condition:</strong> Rex Qty Ordered = 0 AND NETO qty invoiced > 0</p>
                                                        <p class="mb-2"><strong>Description:</strong> A new item has been added to the invoice that wasn't part of the original order. The warehouse may have substituted or added this item. Review and add a note if needed.</p>
                                                        <table class="table table-sm table-bordered changelog-table mb-0">
                                                            <thead class="table-light">
                                                                <tr>
                                                                    <th>Rex Qty Ordered</th>
                                                                    <th>NETO qty invoiced</th>
                                                                    <th>Rex Qty Received</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                <tr>
                                                                    <td>0</td>
                                                                    <td>2</td>
                                                                    <td>-</td>
                                                                </tr>
                                                            </tbody>
                                                        </table>
                                                        <div class="mt-2 p-2 bg-light border-start border-success border-3">
                                                            <small><strong>Result:</strong> 0 items were ordered in REX but 2 items appear on the NETO invoice. The warehouse has added this item to the order - Possible mismatched sku between NETO and REX. Report to management.</small>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- Right Column: After Receival -->
                                            <div class="col-md-6">
                                                <h4 class="mb-3 text-success"><i class="fas fa-box-open"></i> After invoice has been received into REX</h4>
                                                
                                                <!-- Receival Difference -->
                                                <div class="card mb-3 border-primary">
                                                    <div class="card-header bg-primary bg-opacity-10">
                                                        <h5 class="mb-0"><span class="badge bg-primary">Receival Difference</span></h5>
                                                    </div>
                                                    <div class="card-body">
                                                        <p class="mb-2"><strong>Condition:</strong> NETO qty invoiced  Rex Qty Received</p>
                                                        <p class="mb-2"><strong>Description:</strong> The quantity physically received differs from what was invoiced. This indicates a picking error, receiving mistake, or shipping discrepancy. Verify the physical count and add a note documenting the difference.</p>
                                                        <table class="table table-sm table-bordered changelog-table mb-0">
                                                            <thead class="table-light">
                                                                <tr>
                                                                    <th>Rex Qty Ordered</th>
                                                                    <th>NETO qty invoiced</th>
                                                                    <th>Rex Qty Received</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                <tr>
                                                                    <td>5</td>
                                                                    <td>4</td>
                                                                    <td>5</td>
                                                                </tr>
                                                                <tr>
                                                                    <td>5</td>
                                                                    <td>5</td>
                                                                    <td>3</td>
                                                                </tr>
                                                                <tr>
                                                                    <td>5</td>
                                                                    <td>4</td>
                                                                    <td>3</td>
                                                                </tr>
                                                            </tbody>
                                                        </table>
                                                        <div class="mt-2 p-2 bg-light border-start border-primary border-3">
                                                            <small><strong>Examples:</strong> Row 1: 4 invoiced but 5 received (received more). Row 2: 5 invoiced but 3 received (received less). Row 3: 4 invoiced but 3 received (both differ). These scenarios indicate warehouse picking errors, shipping mistakes, or incorrect physical counts during receiving.</small>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <!-- Quantity Changed (After Receival) -->
                                                <div class="card mb-3 border-info">
                                                    <div class="card-header bg-info bg-opacity-10">
                                                        <h5 class="mb-0"><span class="badge bg-info text-dark">Quantity Changed</span></h5>
                                                    </div>
                                                    <div class="card-body">
                                                        <p class="mb-2"><strong>Condition:</strong> Rex Qty Ordered  NETO qty invoiced  Rex Qty Received</p>
                                                        <p class="mb-2"><strong>Description:</strong> All three quantities differ - the ordered, invoiced, and received amounts are all different. This represents a complex discrepancy requiring careful reconciliation. Document all differences with detailed notes.</p>
                                                        <table class="table table-sm table-bordered changelog-table mb-0">
                                                            <thead class="table-light">
                                                                <tr>
                                                                    <th>Rex Qty Ordered</th>
                                                                    <th>NETO qty invoiced</th>
                                                                    <th>Rex Qty Received</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                <tr>
                                                                    <td>10</td>
                                                                    <td>8</td>
                                                                    <td>8</td>
                                                                </tr>
                                                            </tbody>
                                                        </table>
                                                        <div class="mt-2 p-2 bg-light border-start border-info border-3">
                                                            <small><strong>Result:</strong> 10 items ordered, 8 invoiced, and 8 received. The warehouse reduced the quantity on the invoice, and then the same quantity was physically received. Add a note why the quantity is changed.</small>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <!-- Delivery Gap -->
                                                <div class="card mb-3 border-warning">
                                                    <div class="card-header bg-warning bg-opacity-10">
                                                        <h5 class="mb-0"><span class="badge bg-warning text-dark">Delivery Gap</span></h5>
                                                    </div>
                                                    <div class="card-body">
                                                        <p class="mb-2"><strong>Condition:</strong> Rex Qty Ordered = Rex Qty Received BUT  NETO qty invoiced</p>
                                                        <p class="mb-2"><strong>Description:</strong> The received quantity matches the original order but differs from what was invoiced. This suggests the receiver did not update the final received quantity in REX to reflect what was actually received. The receiver needs to update REX to match the actual physical count.</p>
                                                        <table class="table table-sm table-bordered changelog-table mb-0">
                                                            <thead class="table-light">
                                                                <tr>
                                                                    <th>Rex Qty Ordered</th>
                                                                    <th>NETO qty invoiced</th>
                                                                    <th>Rex Qty Received</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                <tr>
                                                                    <td>12</td>
                                                                    <td>8</td>
                                                                    <td>12</td>
                                                                </tr>
                                                            </tbody>
                                                        </table>
                                                        <div class="mt-2 p-2 bg-light border-start border-warning border-3">
                                                            <small><strong>Result:</strong> 12 items ordered, 8 invoiced, but 12 received. The received quantity matches the original order despite the invoice showing less. This indicates the receiver didn't update REX to reflect the actual received amount (should be 8, not 12). Receiver must correct the received quantity.</small>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <!-- No Change (After Receival) -->
                                                <div class="card mb-3 border-secondary">
                                                    <div class="card-header bg-light">
                                                        <h5 class="mb-0"><span class="badge bg-light text-dark">No Change</span></h5>
                                                    </div>
                                                    <div class="card-body">
                                                        <p class="mb-2"><strong>Condition:</strong> Rex Qty Ordered = NETO qty invoiced = Rex Qty Received</p>
                                                        <p class="mb-2"><strong>Description:</strong> Perfect match! All three quantities align correctly - ordered, invoiced, and received quantities are identical. No discrepancies detected and no action required.</p>
                                                        <table class="table table-sm table-bordered changelog-table mb-0">
                                                            <thead class="table-light">
                                                                <tr>
                                                                    <th>Rex Qty Ordered</th>
                                                                    <th>NETO qty invoiced</th>
                                                                    <th>Rex Qty Received</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                <tr>
                                                                    <td>6</td>
                                                                    <td>6</td>
                                                                    <td>6</td>
                                                                </tr>
                                                            </tbody>
                                                        </table>
                                                        <div class="mt-2 p-2 bg-light border-start border-secondary border-3">
                                                            <small><strong>Result:</strong> 6 items ordered, 6 invoiced, and 6 received. Perfect match across the entire order lifecycle! The order was fulfilled exactly as planned with no discrepancies. No action required.</small>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else if (contentType === 'ops-dashboard') {
                // Hide both panels for full-width dashboard
                hideLeftPanel();
                hideRightPanel();
                
                // Make content area full width
                contentArea.style.marginLeft = '0';
                contentArea.style.marginRight = '0';
                contentArea.style.width = '100%';
                
                // Update active menu item
                document.querySelectorAll('.menu-item').forEach(item => {
                    item.classList.remove('active');
                });
                if (event && event.target) {
                    event.target.classList.add('active');
                }
                
                // Load OPS Dashboard content with embedded Looker Studio report
                contentArea.innerHTML = `
                    <div style="height: calc(100vh - 60px); width: 100%; padding: 0; margin: 0;">
                        <iframe 
                            width="100%" 
                            height="100%" 
                            src="https://lookerstudio.google.com/embed/reporting/d2857a7c-1497-4a0d-9cab-58ecfd5242a6/page/p_aol0hf33md" 
                            frameborder="0" 
                            style="border:0" 
                            allowfullscreen 
                            sandbox="allow-storage-access-by-user-activation allow-scripts allow-same-origin allow-popups allow-popups-to-escape-sandbox">
                        </iframe>
                    </div>
                `;
            }
        }
        
        // Global variables for pagination
        let currentPage = 1;
        let pageSize = 10;
        let totalCount = 0;
        let searchTerm = '';
        
        function initializeBigQueryPage() {
            const testConnectionBtn = document.getElementById('testConnectionBtn');
            const refreshDataBtn = document.getElementById('refreshDataBtn');
            const searchBtn = document.getElementById('searchBtn');
            const searchInput = document.getElementById('searchInput');
            // pageSizeSelect removed - no longer using page size dropdown
            
            // Test connection
            if (testConnectionBtn) {
                testConnectionBtn.addEventListener('click', testConnection);
            }
            
            // Refresh data
            if (refreshDataBtn) {
                refreshDataBtn.addEventListener('click', refreshData);
            }
            
            // Search functionality
            searchBtn.addEventListener('click', performSearch);
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    performSearch();
                }
            });
            
            // SKU search functionality
            console.log('Setting up SKU search functionality...');
            const skuSearchInput = document.getElementById('skuSearchInput');
            console.log('SKU search input element:', skuSearchInput);
            const skuSearchBtn = document.getElementById('skuSearchBtn');
            const clearSkuSearchBtn = document.getElementById('clearSkuSearchBtn');
            const clearAllSearchBtn = document.getElementById('clearAllSearchBtn');
            
            skuSearchInput.addEventListener('keydown', function(e) {
                console.log('SKU search keydown event triggered, key:', e.key);
                if (e.key === 'Enter') {
                    console.log('Enter key pressed, calling performSkuSearch');
                    performSkuSearch();
                }
            });
            
            // Also add a click event for testing
            skuSearchInput.addEventListener('click', function(e) {
                console.log('SKU search input clicked!');
            });
            
            // Add input event for testing
            skuSearchInput.addEventListener('input', function(e) {
                console.log('SKU search input changed:', e.target.value);
            });
            
            skuSearchBtn.addEventListener('click', function() {
                console.log('SKU search button clicked!');
                performSkuSearch();
            });
            
            clearSkuSearchBtn.addEventListener('click', clearSkuSearch);
            clearAllSearchBtn.addEventListener('click', clearAllSearches);
            
            // Clear main search functionality
            const clearMainSearchBtn = document.getElementById('clearMainSearchBtn');
            clearMainSearchBtn.addEventListener('click', clearMainSearch);
            
            // Page size functionality removed
            
            // Individual table search functionality removed - now using global search
            
            // Update the timestamp immediately
            updateSidebarCacheStatus();
            
            // Load initial data
            loadData();
        }
        
        function initializeComparisonPage() {
            // The comparison page is simple - it just displays comparison data
            // when loadComparison is called from showPODetails
            console.log('Comparison page initialized');
            
            // Ensure the Comparison menu item is highlighted
            document.querySelectorAll('.menu-item').forEach(item => {
                if (item.textContent.includes('Comparison')) {
                    item.classList.add('active');
                }
            });
            
            // Update the timestamp
            updateSidebarCacheStatus();
            
            // Attach event listeners to buttons
            const refreshDataBtn = document.getElementById('refreshDataBtn');
            const testConnectionBtn = document.getElementById('testConnectionBtn');
            
            if (refreshDataBtn) {
                refreshDataBtn.addEventListener('click', refreshData);
            }
            if (testConnectionBtn) {
                testConnectionBtn.addEventListener('click', testConnection);
            }
            
            // Check if we have current PO data and load it
            if (currentPOData && currentPOData.po_id) {
                setTimeout(() => {
                    loadComparison(currentPOData.po_id, currentPOData.order_id);
                }, 100);
            }
        }
        
        function testConnection() {
            const btn = document.getElementById('testConnectionBtn');
            const status = document.getElementById('connectionStatus');
            const message = document.getElementById('connectionMessage');
            
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';
            }
            
            fetch('/api/bigquery/test')
                .then(response => response.json())
                .then(data => {
                    status.style.display = 'block';
                    if (data.success) {
                        status.className = 'alert alert-success';
                        message.innerHTML = '<i class="fas fa-check-circle"></i> ' + data.message;
                    } else {
                        status.className = 'alert alert-danger';
                        message.innerHTML = '<i class="fas fa-exclamation-circle"></i> ' + data.message;
                    }
                })
                .catch(error => {
                    status.style.display = 'block';
                    status.className = 'alert alert-danger';
                    message.innerHTML = '<i class="fas fa-exclamation-circle"></i> Connection test failed: ' + error.message;
                })
                .finally(() => {
                    if (btn) {
                        btn.disabled = false;
                        btn.innerHTML = '<i class="fas fa-plug"></i> Test Connection';
                    }
                });
        }
        
        function initializeCostPriceCheckPage() {
            // Update the timestamp
            updateSidebarCacheStatus();
            
            // Attach event listeners to Refresh Data and Test Connection buttons
            const refreshDataBtn = document.getElementById('refreshDataBtn');
            const testConnectionBtn = document.getElementById('testConnectionBtn');
            
            if (refreshDataBtn) {
                refreshDataBtn.addEventListener('click', refreshData);
            }
            if (testConnectionBtn) {
                testConnectionBtn.addEventListener('click', testConnection);
            }
            
            const poSearchBtn = document.getElementById('costPricePoSearchBtn');
            const poSearchInput = document.getElementById('costPricePoSearch');
            const clearPoSearchBtn = document.getElementById('costPriceClearPoSearchBtn');
            const skuSearchBtn = document.getElementById('costPriceSkuSearchBtn');
            const skuSearchInput = document.getElementById('costPriceSkuSearch');
            const clearSkuSearchBtn = document.getElementById('costPriceClearSkuSearchBtn');
            
            // PO ID/Order ID search
            poSearchBtn.addEventListener('click', performCostPricePoSearch);
            poSearchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    performCostPricePoSearch();
                }
            });
            clearPoSearchBtn.addEventListener('click', function() {
                poSearchInput.value = '';
                skuSearchInput.value = '';
                window.costPricePrefilterPoId = null; // Clear the prefilter
                loadAllCostPriceItems();
            });
            
            // SKU search
            skuSearchBtn.addEventListener('click', performCostPriceSkuSearch);
            skuSearchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    performCostPriceSkuSearch();
                }
            });
            clearSkuSearchBtn.addEventListener('click', function() {
                skuSearchInput.value = '';
                poSearchInput.value = '';
                window.costPricePrefilterPoId = null; // Clear the prefilter
                loadAllCostPriceItems();
            });
            
            // Check if there's a prefiltered PO ID (from clicking a row in Summary table)
            if (window.costPricePrefilterPoId) {
                // Auto-populate the search field
                poSearchInput.value = window.costPricePrefilterPoId;
                // Trigger the search
                performCostPricePoSearch();
                // Note: We don't clear the prefilter here, so it persists when switching tabs
                // It will only be cleared when user clicks clear button or selects a different PO
            } else {
                // Load all items initially
                loadAllCostPriceItems();
            }
        }
        
        function loadAllCostPriceItems() {
            const loadingSpinner = document.getElementById('costPriceLoadingSpinner');
            const itemsCard = document.getElementById('costPriceItemsCard');
            const itemsContainer = document.getElementById('costPriceItemsContainer');
            
            loadingSpinner.style.display = 'block';
            itemsCard.style.display = 'none';
            
            // Fetch all items from the cache
            fetch('/api/bigquery/items')
                .then(response => response.json())
                .then(data => {
                    loadingSpinner.style.display = 'none';
                    
                    if (data.success && data.data && data.data.length > 0) {
                        displayAllCostPriceItems(data.data);
                    } else {
                        itemsContainer.innerHTML = `
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i> No cost price data available. Please refresh the cache from the Home page.
                            </div>
                        `;
                        itemsCard.style.display = 'block';
                    }
                })
                .catch(error => {
                    loadingSpinner.style.display = 'none';
                    itemsContainer.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-circle"></i> Error loading data: ${error.message}
                        </div>
                    `;
                    itemsCard.style.display = 'block';
                });
        }
        
        function displayAllCostPriceItems(data) {
            const itemsContainer = document.getElementById('costPriceItemsContainer');
            const itemsCard = document.getElementById('costPriceItemsCard');
            const costPriceCount = document.getElementById('costPriceCount');
            
            itemsCard.style.display = 'block';
            costPriceCount.textContent = data.length;
            
            let tableHTML = `
                <div class="alert alert-info mb-3">
                    <i class="fas fa-info-circle"></i> Showing all ${data.length} cost price records. Use the search above to filter results.
                </div>
                <div style="max-height: 600px; overflow-y: auto;">
                    <table class="table table-striped table-hover">
                        <thead style="position: sticky; top: 0; background-color: #e3f2fd; z-index: 10;">
                            <tr>
                                <th>PO ID</th>
                                <th>Order ID</th>
                                <th>SKU</th>
                                <th>Description</th>
                                <th>NETO Cost Price</th>
                                <th>REX Supplier Buy Ex</th>
                                <th>Difference</th>
                                <th>Disparity</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            data.forEach(item => {
                const rowClass = item.disparity ? 'table-warning' : '';
                const difference = item.difference !== null && item.difference !== undefined ? item.difference.toFixed(2) : '-';
                const disparityBadge = item.disparity 
                    ? '<span class="badge bg-danger">true</span>' 
                    : '<span class="badge bg-success">false</span>';
                
                tableHTML += `
                    <tr class="${rowClass}">
                        <td>${item.po_id || '-'}</td>
                        <td>${item.OrderID || '-'}</td>
                        <td>${item.sku || '-'}</td>
                        <td>${item.short_description || '-'}</td>
                        <td>$${item.neto_cost_price !== null ? item.neto_cost_price.toFixed(2) : '0.00'}</td>
                        <td>$${item.rex_supplier_buy_ex !== null ? item.rex_supplier_buy_ex.toFixed(2) : '0.00'}</td>
                        <td>$${difference}</td>
                        <td>${disparityBadge}</td>
                    </tr>
                `;
            });
            
            tableHTML += `
                        </tbody>
                    </table>
                </div>
            `;
            
            itemsContainer.innerHTML = tableHTML;
        }
        
        function performCostPricePoSearch() {
            const poSearchInput = document.getElementById('costPricePoSearch');
            const searchValue = poSearchInput.value.trim();
            
            if (!searchValue) {
                alert('Please enter a PO ID');
                return;
            }
            
            const loadingSpinner = document.getElementById('costPriceLoadingSpinner');
            const itemsCard = document.getElementById('costPriceItemsCard');
            const itemsContainer = document.getElementById('costPriceItemsContainer');
            
            loadingSpinner.style.display = 'block';
            itemsCard.style.display = 'none';
            
            // Search by PO ID only
            fetch(`/api/bigquery/items?po_id=${encodeURIComponent(searchValue)}`)
                .then(response => response.json())
                .then(data => {
                    loadingSpinner.style.display = 'none';
                    
                    if (data.success && data.data && data.data.length > 0) {
                        displayCostPriceItems(data.data, searchValue, 'PO ID');
                    } else {
                        itemsContainer.innerHTML = `
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle"></i> No cost price data found for PO ID: ${searchValue}
                            </div>
                        `;
                        itemsCard.style.display = 'block';
                    }
                })
                .catch(error => {
                    loadingSpinner.style.display = 'none';
                    itemsContainer.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-circle"></i> Error loading data: ${error.message}
                        </div>
                    `;
                    itemsCard.style.display = 'block';
                });
        }
        
        function performCostPriceSkuSearch() {
            const skuSearchInput = document.getElementById('costPriceSkuSearch');
            const searchValue = skuSearchInput.value.trim();
            
            if (!searchValue) {
                alert('Please enter a SKU or Manufacturer SKU');
                return;
            }
            
            const loadingSpinner = document.getElementById('costPriceLoadingSpinner');
            const itemsCard = document.getElementById('costPriceItemsCard');
            const itemsContainer = document.getElementById('costPriceItemsContainer');
            
            loadingSpinner.style.display = 'block';
            itemsCard.style.display = 'none';
            
            fetch(`/api/bigquery/items?sku_search=${encodeURIComponent(searchValue)}`)
                .then(response => response.json())
                .then(data => {
                    loadingSpinner.style.display = 'none';
                    
                    if (data.success && data.data && data.data.length > 0) {
                        displayCostPriceItems(data.data, searchValue, 'SKU');
                    } else {
                        itemsContainer.innerHTML = `
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle"></i> No cost price data found for SKU: ${searchValue}
                            </div>
                        `;
                        itemsCard.style.display = 'block';
                    }
                })
                .catch(error => {
                    loadingSpinner.style.display = 'none';
                    itemsContainer.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-circle"></i> Error loading data: ${error.message}
                        </div>
                    `;
                    itemsCard.style.display = 'block';
                });
        }
        
        function displayCostPriceItems(data, searchValue, searchType) {
            const itemsContainer = document.getElementById('costPriceItemsContainer');
            const itemsCard = document.getElementById('costPriceItemsCard');
            const costPriceCount = document.getElementById('costPriceCount');
            
            itemsCard.style.display = 'block';
            costPriceCount.textContent = data.length;
            
            let tableHTML = `
                <div class="alert alert-info mb-3">
                    <i class="fas fa-info-circle"></i> Showing ${data.length} results for ${searchType}: <strong>${searchValue}</strong>
                </div>
                <div style="max-height: 600px; overflow-y: auto;">
                    <table class="table table-striped table-hover">
                        <thead style="position: sticky; top: 0; background-color: #e3f2fd; z-index: 10;">
                            <tr>
                                <th>PO ID</th>
                                <th>Order ID</th>
                                <th>SKU</th>
                                <th>Description</th>
                                <th>NETO Cost Price</th>
                                <th>REX Supplier Buy Ex</th>
                                <th>Difference</th>
                                <th>Disparity</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            data.forEach(item => {
                const rowClass = item.disparity ? 'table-warning' : '';
                const difference = item.difference !== null && item.difference !== undefined ? item.difference.toFixed(2) : '-';
                const disparityBadge = item.disparity 
                    ? '<span class="badge bg-danger">true</span>' 
                    : '<span class="badge bg-success">false</span>';
                
                tableHTML += `
                    <tr class="${rowClass}">
                        <td>${item.po_id || '-'}</td>
                        <td>${item.OrderID || '-'}</td>
                        <td>${item.sku || '-'}</td>
                        <td>${item.short_description || '-'}</td>
                        <td>$${item.neto_cost_price !== null ? item.neto_cost_price.toFixed(2) : '0.00'}</td>
                        <td>$${item.rex_supplier_buy_ex !== null ? item.rex_supplier_buy_ex.toFixed(2) : '0.00'}</td>
                        <td>$${difference}</td>
                        <td>${disparityBadge}</td>
                    </tr>
                `;
            });
            
            tableHTML += `
                        </tbody>
                    </table>
                </div>
            `;
            
            itemsContainer.innerHTML = tableHTML;
        }
        
        function clearCostPriceResults() {
            const itemsContainer = document.getElementById('costPriceItemsContainer');
            const itemsCard = document.getElementById('costPriceItemsCard');
            const costPriceCount = document.getElementById('costPriceCount');
            
            itemsCard.style.display = 'none';
            costPriceCount.textContent = '0';
            itemsContainer.innerHTML = `
                <div class="text-center text-muted">
                    <i class="fas fa-search fa-3x mb-3"></i>
                    <p>Search by PO ID, Order ID, or SKU to view cost price data</p>
                </div>
            `;
        }
        
        function loadData() {
            const refreshBtn = document.getElementById('refreshDataBtn');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const summaryContainer = document.getElementById('summaryContainer');
            const dataInfo = document.getElementById('dataInfo');
            const paginationNav = document.getElementById('paginationNav');
            
            if (refreshBtn) {
                refreshBtn.disabled = true;
                refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
            }
            loadingSpinner.style.display = 'block';
            summaryContainer.innerHTML = '';
            dataInfo.style.display = 'none';
            paginationNav.style.display = 'none';
            
            // Request cached data (no pagination needed)
            const url = `/api/bigquery/summary${searchTerm ? '?search=' + encodeURIComponent(searchTerm) : ''}`;
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    loadingSpinner.style.display = 'none';
                    
                    if (data.success) {
                        displaySummaryData(data.data);
                        // Hide pagination since we're using scrollable table
                        paginationNav.style.display = 'none';
                        // Show data info
                        updateDataInfo(data.count, data.total_count, data.timestamp);
                    } else {
                        summaryContainer.innerHTML = `
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-circle"></i> Error loading data: ${data.error}
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    loadingSpinner.style.display = 'none';
                    summaryContainer.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-circle"></i> Error loading data: ${error.message}
                        </div>
                    `;
                })
                .finally(() => {
                    if (refreshBtn) {
                        refreshBtn.disabled = false;
                        refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh Data';
                    }
                });
        }
        
        function performSearch() {
            const searchInput = document.getElementById('searchInput');
            searchTerm = searchInput.value.trim();
            currentPage = 1;
            loadData();
            
            // Also filter comparison and items tables if they have data
            filterAllTablesBySearchTerm(searchTerm);
        }
        
        function performSkuSearch() {
            console.log('performSkuSearch function called!');
            const skuSearchInput = document.getElementById('skuSearchInput');
            const skuSearchTerm = skuSearchInput.value.trim();
            
            console.log('SKU search term:', skuSearchTerm);
            
            if (!skuSearchTerm) {
                console.log('No SKU search term provided');
                return;
            }
            
            // Search BigQuery directly for SKU across all data
            searchBigQueryForSku(skuSearchTerm);
        }
        
        // Global function for testing - you can call this from console
        window.testSkuSearch = function(sku) {
            console.log('Testing SKU search with:', sku);
            searchBigQueryForSku(sku);
        };
        
        function searchBigQueryForSku(skuTerm) {
            console.log('Starting SKU search for:', skuTerm);
            // Show loading spinner
            const loadingSpinner = document.getElementById('loadingSpinner');
            loadingSpinner.style.display = 'block';
            
            // Search summary data with SKU filter
            fetch(`/api/bigquery/summary?sku_search=${encodeURIComponent(skuTerm)}`, {
                credentials: 'include'
            })
                .then(response => response.json())
                .then(data => {
                    console.log('Summary search result:', data);
                    if (data.success && data.data) {
                        // Display filtered summary data
                        displaySummaryData(data.data);
                        
                        // Also search items and comparison data
                        searchItemsAndComparisonForSku(skuTerm);
                    } else {
                        console.error('Error searching summary data:', data.message);
                        loadingSpinner.style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error('Error searching summary data:', error);
                    loadingSpinner.style.display = 'none';
                });
        }
        
        function searchItemsAndComparisonForSku(skuTerm) {
            console.log('Searching items for SKU:', skuTerm);
            // Search items data with SKU filter
            fetch(`/api/bigquery/items?sku_search=${encodeURIComponent(skuTerm)}`, {
                credentials: 'include'
            })
                .then(response => response.json())
                .then(data => {
                    console.log('Items search result:', data);
                    if (data.success && data.data) {
                        // Display all items that match the SKU search
                        if (data.data && data.data.length > 0) {
                            currentItemsData = data.data;
                            // For SKU search, we don't have a specific PO, so use the first item's PO
                            currentItemsPoId = data.data[0].po_id;
                            currentItemsOrderId = data.data[0].order_id || null;
                            displayItemsData(data.data, data.data.length, currentItemsPoId, currentItemsOrderId);
                        } else {
                            // No items found for this SKU
                            displayItemsData([], 0, null, null);
                        }
                        
                        // Search comparison data
                        searchComparisonForSku(skuTerm);
                    } else {
                        console.error('Error searching items data:', data.message);
                        document.getElementById('loadingSpinner').style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error('Error searching items data:', error);
                    document.getElementById('loadingSpinner').style.display = 'none';
                });
        }
        
        function searchComparisonForSku(skuTerm) {
            console.log('Searching comparison for SKU:', skuTerm);
            // Search comparison data with SKU filter
            fetch(`/api/bigquery/comparison?sku_search=${encodeURIComponent(skuTerm)}`, {
                credentials: 'include'
            })
                .then(response => response.json())
                .then(data => {
                    console.log('Comparison search result:', data);
                    if (data.success && data.data) {
                        const reviewMap = buildReviewStatusMap(data.reviews || []);
                        window.currentComparisonReviews = reviewMap;
                        displayComparisonData(data.data, data.data.length, reviewMap);
                        window.currentComparisonData = data.data;
                    } else {
                        console.error('Error searching comparison data:', data.message);
                    }
                    // Hide loading spinner
                    document.getElementById('loadingSpinner').style.display = 'none';
                })
                .catch(error => {
                    console.error('Error searching comparison data:', error);
                    document.getElementById('loadingSpinner').style.display = 'none';
                });
        }
        
        function filterAllTablesBySearchTerm(searchTerm) {
            if (!searchTerm) {
                return;
            }
            
            // Check if search term looks like a PO ID (numeric)
            const isPoId = /^\d+$/.test(searchTerm);
            
            if (isPoId) {
                // If searching for a PO ID, try to find it in the summary data and load its details
                loadDataForPoId(searchTerm);
            } else {
                // For non-PO ID searches, filter existing data
                filterExistingData(searchTerm);
            }
        }
        
        function loadDataForPoId(poId) {
            // First, check if we have summary data loaded
            if (window.currentSummaryData && window.currentSummaryData.length > 0) {
                // Find the PO in the summary data
                const poData = window.currentSummaryData.find(item => 
                    item.po_id && item.po_id.toString() === poId
                );
                
                if (poData) {
                    // Load items and comparison data for this PO
                    loadItems(poId, poData.order_id);
                    return;
                }
            }
            
            // If not found in current data, filter existing data
            filterExistingData(poId);
        }
        
        function filterExistingData(searchTerm) {
            // Filter comparison table if it has data
            if (window.currentComparisonData && window.currentComparisonData.length > 0) {
                const filteredComparisonData = window.currentComparisonData.filter(item => 
                    (item.po_id && item.po_id.toString().includes(searchTerm)) ||
                    (item.sku && item.sku.toLowerCase().includes(searchTerm.toLowerCase())) ||
                    (item.name && item.name.toLowerCase().includes(searchTerm.toLowerCase()))
                );
                displayComparisonData(filteredComparisonData, filteredComparisonData.length, window.currentComparisonReviews);
            }
            
            // Filter items table if it has data
            if (currentItemsData && currentItemsData.length > 0) {
                const filteredItemsData = currentItemsData.filter(item => 
                    (item.po_id && item.po_id.toString().includes(searchTerm)) ||
                    (item.sku && item.sku.toLowerCase().includes(searchTerm.toLowerCase())) ||
                    (item.short_description && item.short_description.toLowerCase().includes(searchTerm.toLowerCase()))
                );
                displayItemsData(filteredItemsData, filteredItemsData.length, currentItemsPoId, currentItemsOrderId);
            }
        }
        
        function clearAllSearches() {
            // Clear main search
            const searchInput = document.getElementById('searchInput');
            searchInput.value = '';
            searchTerm = '';
            currentPage = 1;
            loadData();
            
            // Clear SKU search
            const skuSearchInput = document.getElementById('skuSearchInput');
            skuSearchInput.value = '';
            
            // Reset all tables to show all data
            if (window.currentSummaryData) {
                displaySummaryData(window.currentSummaryData);
            }
            if (window.currentComparisonData) {
                displayComparisonData(window.currentComparisonData, window.currentComparisonData.length, window.currentComparisonReviews);
            }
            if (currentItemsData && currentItemsData.length > 0) {
                displayItemsData(currentItemsData, currentItemsData.length, currentItemsPoId, currentItemsOrderId);
            }
        }
        
        function clearMainSearch() {
            const searchInput = document.getElementById('searchInput');
            searchInput.value = '';
            searchTerm = '';
            currentPage = 1;
            loadData();
        }
        
        function clearSkuSearch() {
            const skuSearchInput = document.getElementById('skuSearchInput');
            skuSearchInput.value = '';
            
            // Reset tables to show all data
            if (window.currentSummaryData) {
                displaySummaryData(window.currentSummaryData);
            }
            if (window.currentComparisonData) {
                displayComparisonData(window.currentComparisonData, window.currentComparisonData.length, window.currentComparisonReviews);
            }
            if (currentItemsData && currentItemsData.length > 0) {
                displayItemsData(currentItemsData, currentItemsData.length, currentItemsPoId, currentItemsOrderId);
            }
        }
        
        function refreshData() {
            // Determine current page for return URL after refresh
            let returnUrl = '/dashboard';
            if (document.getElementById('summaryContainer')) {
                returnUrl = '/dashboard'; // REX PO Orders (summary)
            } else if (document.getElementById('comparisonCard')) {
                returnUrl = '/dashboard'; // Comparison view
            } else if (document.getElementById('costPriceContainer')) {
                returnUrl = '/dashboard'; // Cost Price Check
            }
            
            // Redirect to progress screen with autostart and return URL
            window.location.href = `/dashboard-progress?autostart=true&return=${encodeURIComponent(returnUrl)}`;
        }
        
        // Global variable to store current items data for filtering
        let currentItemsData = [];
        let currentItemsPoId = null;
        let currentItemsOrderId = null;
        window.currentComparisonReviews = window.currentComparisonReviews || {};
        let flagReviewModalInstance = null;
        let pendingReviewRowData = null;
        let pendingReviewButtonEl = null;
        
        // Individual comparison search functions removed - now using global search
        
        function addComparisonTableSorting() {
            const sortableHeaders = document.querySelectorAll('#comparisonContainer .sortable');
            let currentSort = { column: null, direction: 'asc' };
            
            sortableHeaders.forEach(header => {
                header.style.cursor = 'pointer';
                header.addEventListener('click', function() {
                    const column = this.getAttribute('data-sort');
                    const tbody = document.querySelector('#comparisonContainer tbody');
                    const rows = Array.from(tbody.querySelectorAll('tr'));
                    
                    // Determine sort direction
                    if (currentSort.column === column) {
                        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                    } else {
                        currentSort.direction = 'asc';
                    }
                    currentSort.column = column;
                    
                    // Update sort icons
                    sortableHeaders.forEach(h => {
                        const icon = h.querySelector('i');
                        icon.className = 'fas fa-sort';
                    });
                    const currentIcon = this.querySelector('i');
                    currentIcon.className = currentSort.direction === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down';
                    
                    // Sort rows
                    rows.sort((a, b) => {
                        const aVal = getCellValue(a, column);
                        const bVal = getCellValue(b, column);
                        
                        // Handle numeric values
                        if (!isNaN(aVal) && !isNaN(bVal)) {
                            return currentSort.direction === 'asc' ? aVal - bVal : bVal - aVal;
                        }
                        
                        // Handle string values
                        const aStr = String(aVal).toLowerCase();
                        const bStr = String(bVal).toLowerCase();
                        
                        if (currentSort.direction === 'asc') {
                            return aStr.localeCompare(bStr);
                        } else {
                            return bStr.localeCompare(aStr);
                        }
                    });
                    
                    // Reorder rows in table
                    rows.forEach(row => tbody.appendChild(row));
                });
            });
        }
        
        function getCellValue(row, column) {
            const cellIndex = getColumnIndex(column);
            if (cellIndex === -1) return '';
            
            const cell = row.cells[cellIndex];
            if (!cell) return '';
            
            // Extract text content, handling badges
            let text = cell.textContent || cell.innerText || '';
            
            // Handle numeric values
            if (!isNaN(text) && text !== '') {
                return parseFloat(text);
            }
            
            return text;
        }
        
        function getColumnIndex(column) {
            const headers = document.querySelectorAll('#comparisonContainer thead th');
            for (let i = 0; i < headers.length; i++) {
                if (headers[i].getAttribute('data-sort') === column) {
                    return i;
                }
            }
            return -1;
        }
        
        function addItemsTableSorting() {
            const sortableHeaders = document.querySelectorAll('#itemsContainer .sortable');
            let currentSort = { column: null, direction: 'asc' };
            
            sortableHeaders.forEach(header => {
                header.style.cursor = 'pointer';
                header.addEventListener('click', function() {
                    const column = this.getAttribute('data-sort');
                    const tbody = document.querySelector('#itemsContainer tbody');
                    const rows = Array.from(tbody.querySelectorAll('tr'));
                    
                    // Determine sort direction
                    if (currentSort.column === column) {
                        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                    } else {
                        currentSort.direction = 'asc';
                    }
                    currentSort.column = column;
                    
                    // Update sort icons
                    sortableHeaders.forEach(h => {
                        const icon = h.querySelector('i');
                        icon.className = 'fas fa-sort';
                    });
                    const currentIcon = this.querySelector('i');
                    currentIcon.className = currentSort.direction === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down';
                    
                    // Sort rows
                    rows.sort((a, b) => {
                        const aVal = getItemsCellValue(a, column);
                        const bVal = getItemsCellValue(b, column);
                        
                        // Handle numeric values
                        if (!isNaN(aVal) && !isNaN(bVal)) {
                            return currentSort.direction === 'asc' ? aVal - bVal : bVal - aVal;
                        }
                        
                        // Handle string values
                        const aStr = String(aVal).toLowerCase();
                        const bStr = String(bVal).toLowerCase();
                        
                        if (currentSort.direction === 'asc') {
                            return aStr.localeCompare(bStr);
                        } else {
                            return bStr.localeCompare(aStr);
                        }
                    });
                    
                    // Reorder rows in table
                    rows.forEach(row => tbody.appendChild(row));
                });
            });
        }
        
        function getItemsCellValue(row, column) {
            const cellIndex = getItemsColumnIndex(column);
            if (cellIndex === -1) return '';
            
            const cell = row.cells[cellIndex];
            if (!cell) return '';
            
            // Extract text content, handling badges and currency
            let text = cell.textContent || cell.innerText || '';
            
            // Remove currency symbols and parse numeric values
            if (text.includes('$')) {
                text = text.replace('$', '');
            }
            
            // Handle numeric values
            if (!isNaN(text) && text !== '') {
                return parseFloat(text);
            }
            
            return text;
        }
        
        function getItemsColumnIndex(column) {
            const headers = document.querySelectorAll('#itemsContainer thead th');
            for (let i = 0; i < headers.length; i++) {
                if (headers[i].getAttribute('data-sort') === column) {
                    return i;
                }
            }
            return -1;
        }

        // Individual search functions removed - now using global search
        
        function displaySummaryData(data) {
            const summaryContainer = document.getElementById('summaryContainer');
            
            // Store summary data globally for search functionality
            window.currentSummaryData = data;
            
            if (!data || data.length === 0) {
                summaryContainer.innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> No data found${searchTerm ? ' for search term: ' + searchTerm : ''}.
                    </div>
                `;
                return;
            }

            // Define the columns we want to show in the summary table
            const summaryColumns = [
                'po_id', 'po_status', 'requested_date', 'OrderID', 'supplier', 'item_count', 'order_link', 'entered_date', 'received_date',
                'neto_order_created_by', 'completed_date', 'order_status', 'disparity'
            ];
            
            // Create table HTML with full height
            let tableHTML = `
                <div class="table-responsive-modern" style="height: 100%; overflow-y: auto;">
                    <table class="table table-modern table-striped table-hover">
                        <thead class="sticky-top">
                            <tr>
                                <th data-bs-toggle="tooltip" data-bs-placement="top" title="Purchase Order ID - Unique identifier for the purchase order" class="text-center">PO ID</th>
                                <th data-bs-toggle="tooltip" data-bs-placement="top" title="Order ID from the system" class="text-center">OrderID</th>
                                <th data-bs-toggle="tooltip" data-bs-placement="top" title="Supplier assigned to this purchase order" class="text-center">Supplier</th>
                                <th data-bs-toggle="tooltip" data-bs-placement="top" title="Number of unique items (order lines) in this purchase order from REX" class="text-center">REX Order Lines</th>
                                <th data-bs-toggle="tooltip" data-bs-placement="top" title="User who created the order in NETO">NETO Order Created By</th>
                                <th data-bs-toggle="tooltip" data-bs-placement="top" title="User who created the purchase order in REX">REX PO Created By</th>
                                <th data-bs-toggle="tooltip" data-bs-placement="top" title="Date when the purchase order was requested in REX" class="text-center">REX Date Requested</th>
                                <th data-bs-toggle="tooltip" data-bs-placement="top" title="Date when the order was entered into NETO" class="text-center">NETO Date Entered</th>
                                <th data-bs-toggle="tooltip" data-bs-placement="top" title="Date when the order was dispatched in NETO" class="text-center">NETO Date Dispatched</th>
                                <th data-bs-toggle="tooltip" data-bs-placement="top" title="Date when the order was received in REX" class="text-center">REX Date Received</th>
                                <th data-bs-toggle="tooltip" data-bs-placement="top" title="Indicates if there's a price difference between REX and NETO" class="text-center">Disparity?</th>
                                <th data-bs-toggle="tooltip" data-bs-placement="top" title="Current status of the purchase order" class="text-center">Status</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            // Add data rows
            data.forEach((row, index) => {
                // Escape single quotes in data for onclick handler
                const requestedDateRaw = row.requested_date ? row.requested_date.replace(/'/g, "\\'") : '';
                const enteredDateRaw = row.entered_date ? row.entered_date.replace(/'/g, "\\'") : '';
                const receivedDateRaw = row.received_date ? row.received_date.replace(/'/g, "\\'") : '';
                const createdByRaw = (row.neto_order_created_by || '').replace(/'/g, "\\'");
                const completedDateRaw = row.completed_date ? row.completed_date.replace(/'/g, "\\'") : '';
                const completionStatusRaw = (row.completion_status || '').replace(/'/g, "\\'");
                const orderStatusRaw = (row.order_status || '').replace(/'/g, "\\'");
                
                // Determine row styling (Cancelled rows will be highlighted inline)
                let rowStyle = 'cursor: pointer;';
                const poStatusRaw = (row.po_status || '').trim();
                const poStatusAttr = poStatusRaw.toLowerCase().replace(/\s+/g, '-');
                const poStatusEscaped = poStatusRaw.replace(/'/g, "\\'");
                if (poStatusAttr === 'cancelled') {
                    rowStyle += ' background-color: #ffe0e0;';
                }
                
                // Escape neto_order_ids for onclick handler
                const netoOrderIdsRaw = (row.neto_order_ids || '').replace(/'/g, "\\'");
                
                tableHTML += `<tr onclick="showPODetails('${row.po_id}', '${row.OrderID}', '${requestedDateRaw}', '${enteredDateRaw}', '${receivedDateRaw}', '${createdByRaw}', '${completedDateRaw}', '${completionStatusRaw}', '${orderStatusRaw}', '${poStatusEscaped}', ${row.disparity || false}, '${netoOrderIdsRaw}')" style="${rowStyle}">`;
                
                // Format each field
                const poId = row.po_id || '-';
                
                // Handle multiple order IDs if present
                let orderId = '-';
                if (row.neto_order_ids && row.neto_order_ids.trim()) {
                    const orderIds = row.neto_order_ids.split(',').map(id => id.trim()).filter(id => id);
                    if (orderIds.length > 0) {
                        const orderLinks = orderIds.map(id => {
                            const link = `https://www.chainsawspares.com.au/_cpanel/order/vieworder?id=${id}`;
                            return `<a href="${link}" target="_blank" onclick="event.stopPropagation();">${id}</a>`;
                        });
                        orderId = orderLinks.join(', ');
                    }
                } else if (row.OrderID) {
                    // Fallback to single order ID if neto_order_ids not available
                    orderId = `<a href="${row.order_link}" target="_blank" onclick="event.stopPropagation();">${row.OrderID}</a>`;
                }
                const supplierName = row.supplier || '-';
                const itemCount = row.item_count || '0';
                const netoCreatedBy = row.neto_order_created_by || '-';
                const rexPOCreatedBy = row.rex_po_created_by || '-';
                const requestedDate = row.requested_date ? new Date(row.requested_date).toLocaleDateString('en-GB', {
                    day: '2-digit', month: 'short', year: 'numeric'
                }) + ', ' + new Date(row.requested_date).toLocaleTimeString('en-GB', {
                    hour: '2-digit', minute: '2-digit', second: '2-digit'
                }) : '-';
                const enteredDate = row.entered_date ? new Date(row.entered_date).toLocaleDateString('en-GB', {
                    day: '2-digit', month: 'short', year: 'numeric'
                }) : '-';
                const completedDate = row.completed_date ? new Date(row.completed_date).toLocaleDateString('en-GB', {
                    day: '2-digit', month: 'short', year: 'numeric'
                }) : '-';
                const receivedDate = row.received_date ? new Date(row.received_date).toLocaleDateString('en-GB', {
                    day: '2-digit', month: 'short', year: 'numeric'
                }) + ', ' + new Date(row.received_date).toLocaleTimeString('en-GB', {
                    hour: '2-digit', minute: '2-digit', second: '2-digit'
                }) : '-';
                const disparity = row.disparity ? 
                    '<span class="badge bg-danger">true</span>' : 
                    '<span class="badge bg-success">false</span>';
                const statusBadge = (() => {
                    const normalizedStatus = (poStatusRaw || '-').toLowerCase();
                    if (!poStatusRaw) return '<span class="badge bg-secondary">Unknown</span>';
                    const badgeClass = normalizedStatus === 'cancelled'
                        ? 'bg-danger'
                        : normalizedStatus === 'available'
                            ? 'bg-success'
                            : normalizedStatus === 'back-order'
                                ? 'bg-warning text-dark'
                                : normalizedStatus === 'on-order'
                                    ? 'bg-primary'
                                    : 'bg-secondary';
                    return `<span class="badge ${badgeClass}">${poStatusRaw}</span>`;
                })();
                
                const reviewInfo = window.currentComparisonReviews[row.po_item_id];
                const reviewCell = renderReviewActionCell(reviewInfo, index);
                
                tableHTML += `
                    <td class="numeric-column">${poId}</td>
                    <td class="text-center">${orderId}</td>
                    <td class="text-center">${supplierName}</td>
                    <td class="text-center">${itemCount}</td>
                    <td>${netoCreatedBy}</td>
                    <td>${rexPOCreatedBy}</td>
                    <td class="text-center">${requestedDate}</td>
                    <td class="text-center">${enteredDate}</td>
                    <td class="text-center">${completedDate}</td>
                    <td class="text-center">${receivedDate}</td>
                    <td class="text-center">${disparity}</td>
                    <td class="text-center">${statusBadge}</td>
                `;
                tableHTML += '</tr>';
            });
            
            tableHTML += `
                        </tbody>
                    </table>
                </div>
            `;
            
            summaryContainer.innerHTML = tableHTML;
            
            // Initialize tooltips for the summary table (with safety check)
            if (typeof bootstrap !== 'undefined') {
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('#summaryContainer [data-bs-toggle="tooltip"]'));
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
            }
        }
        
        function buildReviewStatusMap(reviews) {
            const map = {};
            (reviews || []).forEach(review => {
                if (!review || !review.po_item_id) return;
                map[review.po_item_id] = review;
            });
            return map;
        }
        
        function formatReviewBadge(status) {
            const normalized = (status || 'pending').toLowerCase();
            const label = normalized.replace(/_/g, ' ') || 'flagged';
            let badgeClass = 'bg-danger';
            if (normalized === 'warehouse_in_progress') {
                badgeClass = 'bg-warning text-dark';
            } else if (normalized === 'warehouse_closed' || normalized === 'retail_closed') {
                badgeClass = 'bg-success';
            } else if (normalized === 'cancelled') {
                badgeClass = 'bg-secondary';
            }
            return `<span class="badge ${badgeClass} text-uppercase">${label}</span>`;
        }

        function escapeHtml(value) {
            if (value === null || value === undefined) {
                return '';
            }
            return String(value)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function formatLocalDateTime(value) {
            if (!value) {
                return '-';
            }
            try {
                return new Date(value).toLocaleString('en-AU', { timeZone: 'Australia/Melbourne' });
            } catch (error) {
                return '-';
            }
        }

        function getChangeLogDisplay(changeLogRaw) {
            const label = (changeLogRaw || 'Unknown').trim() || 'Unknown';
            let badgeClass = 'bg-secondary';
            let tooltipText = '';
            switch (label) {
                case 'Back-ordered':
                    badgeClass = 'bg-dark';
                    tooltipText = 'Item is on back-order, waiting for stock availability';
                    break;
                case 'Quantity Changed':
                    badgeClass = 'bg-info text-dark';
                    tooltipText = 'NETO invoiced quantity differs from REX ordered quantity';
                    break;
                case 'Item Removed':
                    badgeClass = 'bg-danger';
                    tooltipText = 'Item not present on NETO invoice (out of stock or excluded)';
                    break;
                case 'No Change':
                    badgeClass = 'bg-light text-dark';
                    break;
                case 'Delivery Gap':
                    badgeClass = 'bg-warning text-dark';
                    tooltipText = 'REX received matches ordered but differs from NETO invoiced';
                    break;
                case 'New Item':
                    badgeClass = 'bg-success';
                    tooltipText = 'New item added that wasn\'t in original REX PO';
                    break;
                case 'Receival Difference':
                    badgeClass = 'bg-primary';
                    tooltipText = 'REX received quantity differs from NETO invoiced quantity';
                    break;
                case 'Pending Invoice':
                    badgeClass = 'bg-secondary';
                    tooltipText = 'Awaiting invoice completion';
                    break;
            }
            return { label, badgeClass, tooltipText };
        }
        
        function renderReviewActionCell(reviewInfo, rowIndex, poItemId) {
            if (reviewInfo && reviewInfo.status) {
                const badge = formatReviewBadge(reviewInfo.status);
                const meta = reviewInfo.flagged_by 
                    ? `<div class="text-muted" style="font-size: 0.7rem;">${reviewInfo.flagged_by}</div>`
                    : '';
                return `<div class="d-flex flex-column align-items-center gap-1">${badge}${meta}</div>`;
            }
            if (!poItemId) {
                return `<span class="text-muted small">Not available</span>`;
            }
            const itemAttr = `data-po-item-id="${poItemId}"`;
            return `
                <button class="btn btn-sm btn-outline-danger flag-review-btn" data-row-index="${rowIndex}" ${itemAttr}>
                    <i class="fas fa-flag"></i> Flag
                </button>
            `;
        }
        
        function attachFlagButtonHandlers() {
            document.querySelectorAll('.flag-review-btn').forEach(button => {
                button.addEventListener('click', function(event) {
                    event.stopPropagation();
                    const rowIndex = parseInt(this.dataset.rowIndex, 10);
                    const poItemId = this.dataset.poItemId;
                    let rowData = null;
                    if (!isNaN(rowIndex) && window.currentComparisonData) {
                        rowData = window.currentComparisonData[rowIndex];
                    }
                    if (!rowData && poItemId && window.currentComparisonData) {
                        rowData = window.currentComparisonData.find(item => String(item.po_item_id) === String(poItemId));
                    }
                    if (!rowData) {
                        alert('Unable to flag this item. Please refresh and try again.');
                        return;
                    }
                    openFlagReviewModal(rowData, this);
                });
            });
        }
        
        function openFlagReviewModal(rowData, triggerButton) {
            if (!flagReviewModalInstance || !rowData) return;
            
            pendingReviewRowData = rowData;
            pendingReviewButtonEl = triggerButton || null;
            
            document.getElementById('flagReviewPoId').textContent = rowData.po_id || '-';
            document.getElementById('flagReviewSku').textContent = rowData.sku || '-';
            document.getElementById('flagReviewName').textContent = rowData.name || rowData.product_name || '-';
            
            const changeLogInfo = getChangeLogDisplay(rowData.change_log);
            document.getElementById('flagReviewChangeLog').innerHTML = `<span class="badge ${changeLogInfo.badgeClass} badge-change-log">${changeLogInfo.label}</span>`;
            
            const latestNoteEl = document.getElementById('flagReviewLatestNote');
            if (rowData.latest_item_note) {
                const author = rowData.latest_item_note_user ? `<strong>${rowData.latest_item_note_user}</strong>` : '';
                latestNoteEl.innerHTML = `${author ? author + ': ' : ''}${rowData.latest_item_note}`;
            } else {
                latestNoteEl.innerHTML = '<span class="text-muted">No notes yet</span>';
            }
            
            const commentInput = document.getElementById('flagReviewComment');
            if (commentInput) {
                commentInput.value = '';
                commentInput.focus();
            }
            updateFlagReviewCharCount();
            showFlagReviewWarning(null);
            setFlagReviewModalLoading(false);
            flagReviewModalInstance.show();
        }
        
        function updateFlagReviewCharCount() {
            const commentInput = document.getElementById('flagReviewComment');
            const countEl = document.getElementById('flagReviewCharCount');
            if (!commentInput || !countEl) return;
            countEl.textContent = commentInput.value.length;
        }
        
        function setFlagReviewModalLoading(isLoading) {
            const confirmBtn = document.getElementById('confirmFlagReviewBtn');
            if (!confirmBtn) return;
            const defaultLabel = confirmBtn.querySelector('.default-label');
            const loadingLabel = confirmBtn.querySelector('.loading-label');
            confirmBtn.disabled = isLoading;
            if (defaultLabel && loadingLabel) {
                if (isLoading) {
                    defaultLabel.classList.add('d-none');
                    loadingLabel.classList.remove('d-none');
                } else {
                    defaultLabel.classList.remove('d-none');
                    loadingLabel.classList.add('d-none');
                }
            }
        }
        
        function showFlagReviewWarning(message) {
            const warningEl = document.getElementById('flagReviewWarning');
            if (!warningEl) return;
            if (message) {
                warningEl.classList.remove('d-none');
                const messageSpan = warningEl.querySelector('.message');
                if (messageSpan) {
                    messageSpan.textContent = message;
                }
            } else {
                warningEl.classList.add('d-none');
            }
        }
        
        function resetFlagReviewModalState() {
            pendingReviewRowData = null;
            pendingReviewButtonEl = null;
            showFlagReviewWarning(null);
            const commentInput = document.getElementById('flagReviewComment');
            if (commentInput) {
                commentInput.value = '';
            }
            updateFlagReviewCharCount();
            setFlagReviewModalLoading(false);
        }
        
        function handleFlagReviewSubmit() {
            if (!pendingReviewRowData || !pendingReviewRowData.po_item_id) {
                alert('Missing item information.');
                return;
            }
            const commentInput = document.getElementById('flagReviewComment');
            const comment = commentInput ? commentInput.value.trim() : '';
            setFlagReviewModalLoading(true);
            showFlagReviewWarning(null);
            
            sendFlagReviewRequest(pendingReviewRowData, comment)
                .then(result => {
                    if (result.success) {
                        window.currentComparisonReviews[pendingReviewRowData.po_item_id] = result.review;
                        if (pendingReviewButtonEl) {
                            pendingReviewButtonEl.outerHTML = renderReviewActionCell(result.review, 0, pendingReviewRowData.po_item_id);
                        }
                        flagReviewModalInstance.hide();
                    } else {
                        showFlagReviewWarning(result.error || 'Failed to flag item for review');
                    }
                })
                .catch(error => {
                    showFlagReviewWarning(error.message || 'Error flagging item. Please try again.');
                })
                .finally(() => {
                    setFlagReviewModalLoading(false);
                });
        }
        
        function sendFlagReviewRequest(rowData, comment) {
            return fetch('/api/reviews/flag', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    po_id: rowData.po_id,
                    order_id: rowData.OrderID || rowData.order_id || null,
                    po_item_id: rowData.po_item_id,
                    sku: rowData.sku,
                    comment: comment,
                    comparison_snapshot: rowData
                })
            }).then(response => response.json());
        }

        function initFlagReviewModal() {
            const modalElement = document.getElementById('flagReviewModal');
            if (!modalElement || typeof bootstrap === 'undefined') {
                return;
            }
            flagReviewModalInstance = new bootstrap.Modal(modalElement);
            const commentInput = document.getElementById('flagReviewComment');
            if (commentInput) {
                commentInput.addEventListener('input', updateFlagReviewCharCount);
            }
            const confirmBtn = document.getElementById('confirmFlagReviewBtn');
            if (confirmBtn) {
                confirmBtn.addEventListener('click', handleFlagReviewSubmit);
            }
            modalElement.addEventListener('hidden.bs.modal', resetFlagReviewModalState);
        }
        
        function loadComparison(poId, orderId) {
            const comparisonCard = document.getElementById('comparisonCard');
            const comparisonContainer = document.getElementById('comparisonContainer');
            const comparisonSearchInput = document.getElementById('comparisonSearchInput');
            
            // Clear search when loading new comparison data
            if (comparisonSearchInput) {
                comparisonSearchInput.value = '';
            }
            
            // Show the comparison card
            comparisonCard.style.display = 'block';
            
            // Show loading with progress indicator
            comparisonContainer.innerHTML = `
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading comparison data for PO: ${poId}</p>
                    <div class="progress mt-3" style="height: 4px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
                    </div>
                    <small class="text-muted mt-2 d-block">Checking cache first, then BigQuery if needed...</small>
                </div>
            `;
            
            // Fetch comparison data with timeout
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout
            
            fetch(`/api/bigquery/comparison?po_id=${poId}&order_id=${orderId}`, {
                credentials: 'include',
                signal: controller.signal
            })
                .then(response => {
                    clearTimeout(timeoutId);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        // Show data source information
                        const dataSource = data.from_cache ? 'cache' : 'BigQuery';
                        const loadTime = data.load_time ? ` (${data.load_time}ms)` : '';
                        
                        // Update loading message to show data source
                        comparisonContainer.innerHTML = `
                            <div class="text-center">
                                <div class="spinner-border text-success" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2 text-success"> Loaded from ${dataSource}${loadTime}</p>
                                <small class="text-muted">Rendering comparison table...</small>
                            </div>
                        `;
                        
                        const reviewMap = buildReviewStatusMap(data.reviews || []);
                        window.currentComparisonReviews = reviewMap;
                        displayComparisonData(data.data, data.total_count, reviewMap);
                        // Store comparison data globally for search
                        window.currentComparisonData = data.data;
                    } else {
                        comparisonContainer.innerHTML = `
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-circle"></i> Error loading comparison data: ${data.error || 'Unknown error'}
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    clearTimeout(timeoutId);
                    let errorMessage = error.message;
                    if (error.name === 'AbortError') {
                        errorMessage = 'Request timed out after 30 seconds. The comparison data is taking too long to load.';
                    }
                    comparisonContainer.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-circle"></i> Error loading comparison data: ${errorMessage}
                            <br><small class="text-muted">Try refreshing the page or contact support if the issue persists.</small>
                        </div>
                    `;
                });
        }

        function loadItems(poId, orderId) {
            const itemsCard = document.getElementById('itemsCard');
            const itemsContainer = document.getElementById('itemsContainer');
            const itemsSearchInput = document.getElementById('itemsSearchInput');
            
            // Clear search when loading new items
            if (itemsSearchInput) {
                itemsSearchInput.value = '';
            }
            
            // Clear any existing notes and close item details panel
            document.getElementById('item-details-panel').style.display = 'none';
            // Don't show Quick Info panel - keep it hidden in REX PO Orders view
            // document.getElementById('quick-info-panel').style.display = 'block';
            document.getElementById('notes-list').innerHTML = `
                <div class="text-center text-muted">
                    <small>No notes yet. Click on an item to add notes.</small>
                </div>
            `;
            document.getElementById('new-note').value = '';
            currentItemData = null;
            
            // Show the items card
            itemsCard.style.display = 'block';
            
            // Show loading
            itemsContainer.innerHTML = `
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading items for PO: ${poId}</p>
                    <small class="text-muted">Checking cache first, then BigQuery if needed...</small>
                </div>
            `;
            
            // Load items data
            const url = `/api/bigquery/items?po_id=${encodeURIComponent(poId)}&order_id=${encodeURIComponent(orderId)}`;
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Show data source information
                        const dataSource = data.from_cache ? 'cache' : 'BigQuery';
                        const loadTime = data.load_time ? ` (${data.load_time}ms)` : '';
                        
                        // Update loading message to show data source
                        itemsContainer.innerHTML = `
                            <div class="text-center">
                                <div class="spinner-border text-success" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2 text-success"> Items loaded from ${dataSource}${loadTime}</p>
                                <small class="text-muted">Rendering items table...</small>
                            </div>
                        `;
                        
                        // Store data for search functionality
                        currentItemsData = data.data;
                        currentItemsPoId = poId;
                        currentItemsOrderId = orderId;
                        
                        // Small delay to show the success message, then render
                        setTimeout(() => {
                            displayItemsData(data.data, data.total_count, poId, orderId);
                            
                            // Also load comparison data
                            loadComparison(poId, orderId);
                        }, 500);
                    } else {
                        itemsContainer.innerHTML = `
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-circle"></i> Error loading items: ${data.error}
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    itemsContainer.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-circle"></i> Error loading items: ${error.message}
                        </div>
                    `;
                });
        }
        
        function displayComparisonData(data, totalCount, reviewStatuses = {}) {
            const comparisonContainer = document.getElementById('comparisonContainer');
            window.currentComparisonReviews = reviewStatuses || {};
            
            console.log('displayComparisonData received data:', data);
            
            if (!data || data.length === 0) {
                comparisonContainer.innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> No comparison data found for this purchase order.
                    </div>
                `;
                return;
            }
            
            // Get PO ID from first row for the info message
            const poId = data[0]?.po_id || '-';
            const poStatusRaw = (currentPOData?.po_status || 'Unknown').trim() || 'Unknown';
            const statusClasses = {
                'cancelled': 'bg-danger',
                'available': 'bg-success',
                'on-order': 'bg-primary',
                'incomplete': 'bg-warning text-dark',
                'back-order': 'bg-dark'
            };
            const statusClass = statusClasses[poStatusRaw.toLowerCase()] || 'bg-secondary';
            const statusBadge = `<span class="badge ${statusClass}">${poStatusRaw || 'Unknown'}</span>`;
            
            // Check if we have multiple NETO order IDs from currentPOData (from Summary table)
            let orderIdDisplay = '<strong>-</strong>';
            const netoOrderIds = currentPOData?.neto_order_ids || '';
            
            // Check if we have multiple order IDs from the Summary table
            if (netoOrderIds && netoOrderIds.trim()) {
                const orderIds = netoOrderIds.split(',').map(id => id.trim()).filter(id => id);
                if (orderIds.length > 0) {
                    const orderLinks = orderIds.map(id => {
                        const link = `https://www.chainsawspares.com.au/_cpanel/order/vieworder?id=${id}`;
                        return `<strong><a href="${link}" target="_blank" style="color: #0056b3; text-decoration: underline;">${id}</a></strong>`;
                    });
                    orderIdDisplay = orderLinks.join(', ');
                }
            } else {
                // Fallback to single OrderID from comparison data if neto_order_ids not available
                const recordWithOrderId = data.find(row => row.OrderID && row.OrderID !== null && row.OrderID !== '-');
                const orderId = recordWithOrderId?.OrderID || currentPOData?.order_id || '-';
                const orderLink = orderId !== '-' ? `https://www.chainsawspares.com.au/_cpanel/order/vieworder?id=${orderId}` : null;
                orderIdDisplay = (orderId !== '-' && orderLink) 
                    ? `<strong><a href="${orderLink}" target="_blank" style="color: #0056b3; text-decoration: underline;">${orderId}</a></strong>`
                    : `<strong>${orderId}</strong>`;
            }
            
            // Create info message showing which PO is being viewed
            const isPlural = netoOrderIds && netoOrderIds.split(',').length > 1;
            let tableHTML = `
                <div class="alert alert-info d-flex align-items-center mb-3" style="background-color: #d1ecf1; border-color: #bee5eb;">
                    <i class="fas fa-info-circle me-2"></i>
                    <span>Showing ${totalCount} result${totalCount !== 1 ? 's' : ''} for PO ID: <strong>${poId}</strong> | Order ID${isPlural ? 's' : ''}: ${orderIdDisplay} | Status: ${statusBadge}</span>
                </div>
            `;
            
            // Add warning banner if multiple NETO order IDs exist
            if (isPlural) {
                tableHTML += `
                    <div class="alert alert-warning d-flex align-items-center mb-3" style="background-color: #fff3cd; border-color: #ffc107;">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <span><strong>Warning:</strong> Possible duplication of data because this PO is linked to multiple NETO Orders</span>
                    </div>
                `;
            }
            
            tableHTML += `
                <div class="table-responsive-modern" style="height: 100%; overflow-y: auto;">
                    <table class="table table-modern table-striped table-hover">
                        <thead class="sticky-top">
                            <tr>
                                <th data-bs-toggle="tooltip" data-bs-placement="top" title="Purchase Order ID" class="sortable text-center" data-sort="po_id" style="width: 60px;">POID <i class="fas fa-sort"></i></th>
                                <th data-bs-toggle="tooltip" data-bs-placement="top" title="Stock Keeping Unit identifier" class="sortable" data-sort="sku" style="width: 100px;">SKU <i class="fas fa-sort"></i></th>
                                <th data-bs-toggle="tooltip" data-bs-placement="top" title="Product name and description" class="sortable" data-sort="name" style="width: 200px;">Name <i class="fas fa-sort"></i></th>
                                <th data-bs-toggle="tooltip" data-bs-placement="top" title="Type of change or difference" class="sortable text-center" data-sort="change_log" style="width: 120px;">Change Log <i class="fas fa-sort"></i></th>
                                <th data-bs-toggle="tooltip" data-bs-placement="top" title="Quantity available in REX system" class="sortable text-center" data-sort="rex_available_qty" style="width: 80px;">REX Qty Available <i class="fas fa-sort"></i></th>
                                <th data-bs-toggle="tooltip" data-bs-placement="top" title="Quantity available in NETO system" class="sortable text-center" data-sort="neto_qty_available" style="width: 80px;">NETO Qty Available <i class="fas fa-sort"></i></th>
                                <th data-bs-toggle="tooltip" data-bs-placement="top" title="Original quantity ordered in REX system" class="sortable text-center" data-sort="original_rex_qty_ordered" style="width: 80px;">Original REX Qty Ordered <i class="fas fa-sort"></i></th>
                                <th data-bs-toggle="tooltip" data-bs-placement="top" title="Quantity invoiced from NETO" class="sortable text-center" data-sort="neto_qty_shipped" style="width: 80px;">NETO Qty Invoiced <i class="fas fa-sort"></i></th>
                                <th data-bs-toggle="tooltip" data-bs-placement="top" title="Quantity received in REX" class="sortable text-center" data-sort="rex_qty_received" style="width: 80px;">REX Qty Received <i class="fas fa-sort"></i></th>
                                <th data-bs-toggle="tooltip" data-bs-placement="top" title="Most recent item-level note or comment" class="text-start" style="min-width: 250px;">Latest Note</th>
                                <th class="text-center" style="width: 140px;">Review</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            // Sort data so similar change logs stay grouped and lowest-priority
            // states (No Change, Back-ordered, Pending Invoice, Item Removed)
            // appear at the bottom in the specified order.
            data.sort((a, b) => {
                const normalize = (value) => (value || 'No Change').trim();
                const aChangeLog = normalize(a.change_log);
                const bChangeLog = normalize(b.change_log);
                
                // Lower number = higher priority (top of the table)
                const changeLogPriority = {
                    'Item Removed': 2,        // fourth last
                    'Pending Invoice': 3,     // third last
                    'Back-ordered': 4,        // second last
                    'Back Order': 4,          // alias safeguard
                    'No Change': 5            // very bottom
                };
                const getPriority = (changeLog) => changeLogPriority[changeLog] || 1;
                
                const aPriority = getPriority(aChangeLog);
                const bPriority = getPriority(bChangeLog);
                
                if (aPriority !== bPriority) {
                    return aPriority - bPriority;
                }
                
                // Items with same priority are grouped by their change log label
                if (aChangeLog !== bChangeLog) {
                    return aChangeLog.localeCompare(bChangeLog);
                }
                
                // Stable-ish fallback: sort by SKU to keep grouping predictable
                const aSku = a.sku || '';
                const bSku = b.sku || '';
                return aSku.localeCompare(bSku);
            });
            
            data.forEach((row, index) => {
                const changeLogInfo = getChangeLogDisplay(row.change_log);
                const changeLogTooltipAttr = changeLogInfo.tooltipText ? `data-bs-toggle="tooltip" data-bs-placement="top" title="${changeLogInfo.tooltipText}"` : '';
                const changeLogTag = `<span class="badge ${changeLogInfo.badgeClass}" ${changeLogTooltipAttr}>${changeLogInfo.label}</span>`;
                
                // No row background colors - badges provide sufficient visual distinction
                let rowBgClass = '';
                
                // Format latest item note - show full note text
                const latestItemNote = row.latest_item_note ? 
                    `<div style="word-wrap: break-word; white-space: normal;">
                        <small class="text-muted">${row.latest_item_note_user}:</small> ${row.latest_item_note}
                    </div>` : 
                    '<span class="text-muted">-</span>';
                
            // Check if item has valid po_item_id for notes functionality
            // Since we're using INNER JOIN, all items should have valid po_item_id
            console.log('Row po_item_id:', row.po_item_id, 'Type:', typeof row.po_item_id);
            const hasValidPoItemId = row.po_item_id && row.po_item_id !== null && row.po_item_id !== undefined;
            
            // Escape JavaScript string values to prevent syntax errors
            function escapeJsString(str) {
                return String(str || '')
                    .replace(/\\/g, '\\\\')     // Backslashes first
                    .replace(/'/g, "\\'")       // Single quotes
                    .replace(/"/g, '\\"')       // Double quotes
                    .replace(/\n/g, '\\n')      // Newlines
                    .replace(/\r/g, '\\r')      // Carriage returns
                    .replace(/\t/g, '\\t')      // Tabs
                    .replace(/`/g, '\\`')       // Backticks
                    .replace(/\0/g, '\\0')      // Null characters
                    .replace(/\u2028/g, '\\u2028') // Line separator
                    .replace(/\u2029/g, '\\u2029'); // Paragraph separator
            }
            
            const escapedPoItemId = escapeJsString(row.po_item_id);
            const escapedPoId = escapeJsString(row.po_id);
            const escapedSku = escapeJsString(row.sku);
            const escapedName = escapeJsString(row.name);
            const escapedChangeLog = escapeJsString(row.change_log);
            const escapedNetoQtyAvailable = escapeJsString(row.neto_qty_available);
            const escapedOriginalRexQtyOrdered = escapeJsString(row.original_rex_qty_ordered);
            const escapedNetoQtyShipped = escapeJsString(row.neto_qty_shipped);
            const escapedRexQtyReceived = escapeJsString(row.rex_qty_received);
            
            // Add clickable class only if item has valid po_item_id
            const clickableClass = hasValidPoItemId ? 'clickable-row' : 'non-clickable-row';
            const dataAttributes = hasValidPoItemId ? 
                `data-po-item-id="${escapedPoItemId}" data-po-id="${escapedPoId}" data-sku="${escapedSku}" data-name="${escapedName}" data-change-log="${escapedChangeLog}" data-neto-qty-available="${escapedNetoQtyAvailable}" data-original-rex-qty-ordered="${escapedOriginalRexQtyOrdered}" data-neto-qty-shipped="${escapedNetoQtyShipped}" data-rex-qty-received="${escapedRexQtyReceived}"` : 
                `data-po-id="${escapedPoId}" data-sku="${escapedSku}" data-name="${escapedName}" data-change-log="${escapedChangeLog}" data-neto-qty-available="${escapedNetoQtyAvailable}" data-original-rex-qty-ordered="${escapedOriginalRexQtyOrdered}" data-neto-qty-shipped="${escapedNetoQtyShipped}" data-rex-qty-received="${escapedRexQtyReceived}"`;
            
            // Add tooltip for non-clickable rows
            const tooltipAttr = hasValidPoItemId ? '' : 'data-bs-toggle="tooltip" data-bs-placement="top" title="This item cannot be clicked because it has no item ID. It may be a comparison-only item that doesn\'t exist in the main items table."';
            
            const reviewInfo = window.currentComparisonReviews[row.po_item_id];
            const reviewCell = renderReviewActionCell(reviewInfo, index, row.po_item_id);
            
            // Display "NOT FOUND" in red if SKU is missing
            const skuDisplay = row.sku ? row.sku : '<span style="color: red; font-weight: bold;">NOT FOUND</span>';
            
            tableHTML += `
                <tr class="${rowBgClass} ${clickableClass}" ${dataAttributes} ${tooltipAttr}>
                    <td class="numeric-column">${row.po_id || '-'}</td>
                    <td>${skuDisplay}</td>
                    <td>${row.name || '-'}</td>
                    <td class="text-center">${changeLogTag}</td>
                    <td class="numeric-column">${row.rex_available_qty !== null && row.rex_available_qty !== undefined ? row.rex_available_qty : 0}</td>
                    <td class="numeric-column">${row.neto_qty_available || '-'}</td>
                    <td class="numeric-column">${row.original_rex_qty_ordered || '-'}</td>
                    <td class="numeric-column">${row.neto_qty_shipped || '-'}</td>
                    <td class="numeric-column">${row.rex_qty_received || '-'}</td>
                    <td class="text-start">${latestItemNote}</td>
                    <td class="text-center">${reviewCell}</td>
                </tr>
            `;
            });
            
            tableHTML += `
                        </tbody>
                    </table>
                </div>
            `;
            
            comparisonContainer.innerHTML = tableHTML;
            attachFlagButtonHandlers();
            
            // Add event listeners for clickable rows
            const clickableRows = comparisonContainer.querySelectorAll('.clickable-row');
            clickableRows.forEach(row => {
                row.addEventListener('click', function() {
                    const poItemId = this.getAttribute('data-po-item-id');
                    const poId = this.getAttribute('data-po-id');
                    const sku = this.getAttribute('data-sku');
                    const name = this.getAttribute('data-name');
                    const changeLog = this.getAttribute('data-change-log');
                    const netoQtyAvailable = this.getAttribute('data-neto-qty-available');
                    const originalRexQtyOrdered = this.getAttribute('data-original-rex-qty-ordered');
                    const netoQtyShipped = this.getAttribute('data-neto-qty-shipped');
                    const finalRexQtyOrdered = this.getAttribute('data-final-rex-qty-ordered');
                    const rexQtyReceived = this.getAttribute('data-rex-qty-received');
                    
                    if (poItemId && poItemId !== 'undefined' && poItemId !== 'null' && poItemId !== 'None') {
                        showComparisonItemDetails(poItemId, poId, sku, name, changeLog, netoQtyAvailable, originalRexQtyOrdered, netoQtyShipped, finalRexQtyOrdered, rexQtyReceived);
                    }
                });
            });
            
            // Update the count badge in the header
            const comparisonBadge = document.querySelector('#comparisonCard .badge');
            if (comparisonBadge) {
                comparisonBadge.textContent = `${totalCount}`;
            }
            
            // Initialize tooltips (with safety check)
            if (typeof bootstrap !== 'undefined') {
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('#comparisonContainer [data-bs-toggle="tooltip"]'));
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
            }
            
            // Add sorting functionality
            addComparisonTableSorting();
        }

        function displayItemsData(data, totalCount, poId, orderId) {
            const itemsContainer = document.getElementById('itemsContainer');
            const itemsCard = document.getElementById('itemsCard');
            
            // Show the items card
            itemsCard.style.display = 'block';
            
            if (!data || data.length === 0) {
                itemsContainer.innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> No items found for this purchase order.
                    </div>
                `;
                return;
            }

            // Show total items count at the top
            // No need for total items info strip - count will be shown in header

            // Create table HTML matching the template format
            // Add scrollable container if 10+ rows
            const maxHeight = data.length >= 10 ? 'max-height: 500px; overflow-y: auto;' : '';
            let tableHTML = `
                <div class="table-responsive-modern" style="${maxHeight}">
                    <table class="table table-modern">
                        <thead class="sticky-top">
                            <tr>
                                <th data-bs-toggle="tooltip" data-bs-placement="top" title="Purchase Order number" class="sortable text-center" data-sort="po_id">PO <i class="fas fa-sort"></i></th>
                                <th data-bs-toggle="tooltip" data-bs-placement="top" title="Stock Keeping Unit - Product identifier" class="sortable" data-sort="sku">SKU <i class="fas fa-sort"></i></th>
                                <th data-bs-toggle="tooltip" data-bs-placement="top" title="Product name and description" class="sortable" data-sort="short_description">Product Name <i class="fas fa-sort"></i></th>
                                <th data-bs-toggle="tooltip" data-bs-placement="top" title="Cost price in NETO system" class="sortable text-end" data-sort="neto_cost_price">NETO Cost Price <i class="fas fa-sort"></i></th>
                                <th data-bs-toggle="tooltip" data-bs-placement="top" title="Supplier buy price in REX system (excluding tax)" class="sortable text-end" data-sort="rex_supplier_buy_ex">REX Supplier Buy Ex <i class="fas fa-sort"></i></th>
                                <th data-bs-toggle="tooltip" data-bs-placement="top" title="Difference between NETO Cost Price and REX Supplier Buy Ex" class="sortable text-end" data-sort="difference">Diff <i class="fas fa-sort"></i></th>
                                <th data-bs-toggle="tooltip" data-bs-placement="top" title="Boolean flag indicating if there's a disparity" class="sortable text-center" data-sort="disparity">Disparity <i class="fas fa-sort"></i></th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            // Add data rows
            data.forEach((row, index) => {
                tableHTML += `<tr>`;
                
                // Format each field according to the template
                const po = row.po_id || '-';
                const sku = row.sku || '-';
                const productName = row.short_description || '-';
                const netoCostPrice = row.neto_cost_price ? `$${parseFloat(row.neto_cost_price).toFixed(2)}` : '-';
                const rexSupplierBuyEx = row.rex_supplier_buy_ex ? `$${parseFloat(row.rex_supplier_buy_ex).toFixed(2)}` : '-';
                const diff = row.difference ? `$${parseFloat(row.difference).toFixed(2)}` : '-';
                const disparity = row.disparity ? 
                    '<span class="badge bg-danger">true</span>' : 
                    '<span class="badge bg-success">false</span>';
                
            tableHTML += `
                <td class="numeric-column">${po}</td>
                <td>${sku}</td>
                <td>${productName}</td>
                <td class="price-column">${netoCostPrice}</td>
                <td class="price-column">${rexSupplierBuyEx}</td>
                <td class="price-column">${diff}</td>
                <td class="text-center">${disparity}</td>
            `;
                tableHTML += '</tr>';
            });
            
            tableHTML += `
                        </tbody>
                    </table>
                </div>
            `;
            
            itemsContainer.innerHTML = tableHTML;
            
            // Update the count badge in the header
            const itemsBadge = document.querySelector('#itemsCard .badge');
            if (itemsBadge) {
                itemsBadge.textContent = `${totalCount}`;
            }
            
            // Initialize tooltips for the items table (with safety check)
            if (typeof bootstrap !== 'undefined') {
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('#itemsContainer [data-bs-toggle="tooltip"]'));
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
            }
            
            // Add sorting functionality to items table
            addItemsTableSorting();
        }
        
        function updatePagination(totalCount, limit, offset) {
            const paginationNav = document.getElementById('paginationNav');
            const totalPages = Math.ceil(totalCount / limit);
            
            if (totalPages <= 1) {
                paginationNav.style.display = 'none';
                return;
            }
            
            paginationNav.style.display = 'block';
            
            const prevPage = document.getElementById('prevPage');
            const currentPageSpan = document.getElementById('currentPage');
            const nextPage = document.getElementById('nextPage');
            
            // Update current page display
            currentPageSpan.innerHTML = `<span class="page-link">${currentPage} of ${totalPages}</span>`;
            
            // Update previous button
            if (currentPage <= 1) {
                prevPage.classList.add('disabled');
                prevPage.querySelector('a').onclick = null;
            } else {
                prevPage.classList.remove('disabled');
                prevPage.querySelector('a').onclick = () => changePage(-1);
            }
            
            // Update next button
            if (currentPage >= totalPages) {
                nextPage.classList.add('disabled');
                nextPage.querySelector('a').onclick = null;
            } else {
                nextPage.classList.remove('disabled');
                nextPage.querySelector('a').onclick = () => changePage(1);
            }
        }
        
        function updateDataInfo(count, totalCount, timestamp) {
            const dataInfo = document.getElementById('dataInfo');
            const dataCount = document.getElementById('dataCount');
            const dataTimestamp = document.getElementById('dataTimestamp');
            
            dataCount.textContent = `Showing ${count} of ${totalCount} records`;
            dataTimestamp.textContent = new Date(timestamp).toLocaleString();
            dataInfo.style.display = 'block';
        }
        
        function changePage(direction) {
            const totalPages = Math.ceil(totalCount / pageSize);
            const newPage = currentPage + direction;
            
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                loadData();
            }
        }
        
        // Update timestamp in main content area (Melbourne time)
        function updateMainTimestamp(lastCached) {
            const timestampElement = document.getElementById('timestampText');
            if (!timestampElement) return;
            
            if (lastCached) {
                // Parse UTC timestamp from server
                const utcDate = new Date(lastCached);
                
                // Format to Melbourne time (AEDT/AEST)
                const melbourneTime = utcDate.toLocaleString('en-AU', {
                    timeZone: 'Australia/Melbourne',
                    year: 'numeric',
                    month: 'short',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: true
                });
                
                timestampElement.textContent = `Last refreshed: ${melbourneTime} (Melbourne)`;
            } else {
                timestampElement.textContent = 'No data cached yet';
            }
        }
        
        // Cache status functionality for sidebar
        function updateSidebarCacheStatus() {
            fetch('/api/bigquery/cache-status')
                .then(response => response.json())
                .then(data => {
                    const cacheStatusDiv = document.getElementById('sidebarCacheStatus');
                    const cacheButtons = document.getElementById('sidebarCacheButtons');
                    
                    if (data.success) {
                        const statusHtml = `
                            <div class="d-flex align-items-center mb-1">
                                <i class="fas fa-${data.has_cached_data ? 'check-circle text-success' : 'exclamation-triangle text-warning'} me-2"></i>
                                <small class="fw-bold">${data.has_cached_data ? 'Cached' : 'No Cache'}</small>
                            </div>
                            <div class="d-flex justify-content-between">
                                <small class="text-muted">Summary:</small>
                                <small class="fw-bold">${data.summary_count}</small>
                            </div>
                            <div class="d-flex justify-content-between">
                                <small class="text-muted">Items:</small>
                                <small class="fw-bold">${data.items_count}</small>
                            </div>
                            <div class="d-flex justify-content-between">
                                <small class="text-muted">Comparison:</small>
                                <small class="fw-bold">${data.comparison_count || 0}</small>
                            </div>
                        `;
                        cacheStatusDiv.innerHTML = statusHtml;
                        cacheButtons.style.display = 'block';
                        
                        // Update main content timestamp if element exists
                        updateMainTimestamp(data.last_cached);
                    } else {
                        cacheStatusDiv.innerHTML = `
                            <div class="text-center text-danger">
                                <i class="fas fa-exclamation-circle"></i>
                                <small class="d-block mt-1">Error</small>
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    document.getElementById('sidebarCacheStatus').innerHTML = `
                        <div class="text-center text-danger">
                            <i class="fas fa-exclamation-circle"></i>
                            <small class="d-block mt-1">Error</small>
                        </div>
                    `;
                });
        }
        
        function refreshSidebarCache() {
            const btn = document.getElementById('sidebarRefreshBtn');
            const originalText = btn.innerHTML;
            
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
            
            fetch('/api/bigquery/refresh', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update cache status after refresh
                    setTimeout(updateSidebarCacheStatus, 1000);
                }
            })
            .catch(error => {
                console.error('Error refreshing cache:', error);
            })
            .finally(() => {
                btn.disabled = false;
                btn.innerHTML = originalText;
            });
        }
        
        function clearSidebarCache() {
            if (!confirm('Are you sure you want to clear all cached data?')) {
                return;
            }
            
            const btn = document.getElementById('sidebarClearBtn');
            const originalText = btn.innerHTML;
            
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Clearing...';
            
            fetch('/api/bigquery/clear-cache', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update cache status after clearing
                    setTimeout(updateSidebarCacheStatus, 500);
                }
            })
            .catch(error => {
                console.error('Error clearing cache:', error);
            })
            .finally(() => {
                btn.disabled = false;
                btn.innerHTML = originalText;
            });
        }
        
        // Initialize cache status on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing dashboard...');
            console.log('Testing if JavaScript is working...');
            updateSidebarCacheStatus();
            
            // Handle sidebar refresh button
            document.getElementById('sidebarRefreshBtn').addEventListener('click', function() {
                refreshSidebarCache();
            });
            
            // Handle sidebar clear button
            document.getElementById('sidebarClearBtn').addEventListener('click', function() {
                clearSidebarCache();
            });
            
            // Update cache status every 30 seconds
            setInterval(updateSidebarCacheStatus, 30000);
        });
        
        // Item Details and Notes Functions
        let currentItemData = null;
        let currentPOData = null;
        
        function showPODetails(poId, orderId, requestedDate, enteredDate, receivedDate, createdBy, completedDate, completionStatus, orderStatus, poStatus, disparity, netoOrderIds) {
            currentPOData = {
                po_id: poId,
                order_id: orderId,
                requested_date: requestedDate,
                entered_date: enteredDate,
                received_date: receivedDate,
                created_by: createdBy,
                completed_date: completedDate,
                completion_status: completionStatus,
                order_status: orderStatus,
                po_status: poStatus,
                disparity: disparity,
                neto_order_ids: netoOrderIds || ''
            };
            
            // Store PO ID for Cost Price Check pre-filtering
            window.costPricePrefilterPoId = poId;
            
            // Switch to Comparison tab
            loadContent('comparison', null);
            
            // Manually activate the Comparison menu item
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelectorAll('.menu-item').forEach(item => {
                if (item.textContent.includes('Comparison')) {
                    item.classList.add('active');
                }
            });
            
            // Show PO info inline in left panel
            const poInfoInline = document.getElementById('po-info-inline');
            if (poInfoInline) {
                poInfoInline.style.display = 'block';
            }
            
            // Populate PO info inline
            populatePOInfoInline();
            
            // Load all item notes for this PO
            loadAllItemNotesForPO(poId);
            
            // Load comparison data for this PO
            setTimeout(() => {
                loadComparison(poId, orderId);
            }, 100);
        }
        
        function closePODetails() {
            // Hide the All Item Notes card
            const allItemNotesCard = document.getElementById('allItemNotesCard');
            if (allItemNotesCard) {
                allItemNotesCard.style.display = 'none';
            }
            currentPOData = null;
        }
        
        function populatePOInfoInline() {
            if (!currentPOData) return;
            
            const infoInline = document.getElementById('po-info-inline');
            if (infoInline) {
                infoInline.innerHTML = `
                    <strong>PO ID:</strong> ${currentPOData.po_id} | <strong>Order ID:</strong> ${currentPOData.order_id}
                `;
            }
        }
        
        // Legacy function - kept for compatibility
        function populatePOInfoHeader() {
            populatePOInfoInline();
        }
        
        function loadPONotes(poId) {
            fetch(`/api/po-notes/${poId}`, {
                credentials: 'include'
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayPONotes(data.notes);
                    } else {
                        console.error('Error loading PO notes:', data.error);
                        displayPONotes([]);
                    }
                })
                .catch(error => {
                    console.error('Error loading PO notes:', error);
                    displayPONotes([]);
                });
        }
        
        function displayPONotes(notes) {
            const notesList = document.getElementById('po-notes-list');
            
            if (notes.length === 0) {
                notesList.innerHTML = `
                    <div class="text-center text-muted">
                        <small>No PO notes yet. Add a comment below.</small>
                    </div>
                `;
                return;
            }
            
            let notesHTML = '';
            notes.forEach(note => {
                const timestamp = new Date(note.created_at).toLocaleString('en-AU', {
                    timeZone: 'Australia/Melbourne',
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                notesHTML += `
                    <div class="note-item-card">
                        <div class="note-item-header">
                            <span class="note-sku">${note.username}</span>
                            <button class="note-delete-btn" onclick="deletePONote('${note.note_id}')" title="Delete note">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        <p class="note-body">${note.comment}</p>
                        <div class="note-footer">
                            <span><i class="fas fa-clock me-1"></i>${timestamp}</span>
                            <span>PO Note</span>
                        </div>
                    </div>
                `;
            });
            
            notesList.innerHTML = notesHTML;
        }
        
        function loadAllItemNotesForPO(poId) {
            fetch(`/api/po-item-notes/${poId}`, {
                credentials: 'include'
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayAllItemNotes(data.notes);
                    } else {
                        console.error('Error loading all item notes:', data.error);
                        displayAllItemNotes([]);
                    }
                })
                .catch(error => {
                    console.error('Error loading all item notes:', error);
                    displayAllItemNotes([]);
                });
        }
        
        function displayAllItemNotes(notes) {
            const notesList = document.getElementById('all-item-notes-list');
            const notesCount = document.getElementById('all-item-notes-count');
            
            // Update the badge count
            notesCount.textContent = notes.length;
            
            if (notes.length === 0) {
                notesList.innerHTML = `
                    <div class="text-center text-muted" style="padding: 2rem 1rem;">
                        <small>No item notes yet. Click on items in the Comparison table to add notes.</small>
                    </div>
                `;
                return;
            }
            
            let notesHTML = '';
            notes.forEach(note => {
                const timestamp = new Date(note.created_at).toLocaleString('en-AU', {
                    timeZone: 'Australia/Melbourne',
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                notesHTML += `
                    <div class="note-item-card">
                        <div class="note-item-header">
                            <span class="note-sku">${note.sku || 'N/A'}</span>
                            <button class="note-delete-btn" onclick="deleteNote('${note.note_id}')" title="Delete note">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        <p class="note-body">${note.comment || ''}</p>
                        <div class="note-footer">
                            <span><i class="fas fa-user me-1"></i>${note.username}</span>
                            <span><i class="fas fa-clock me-1"></i>${timestamp}</span>
                        </div>
                    </div>
                `;
            });
            
            notesList.innerHTML = notesHTML;
        }
        
        function savePONote() {
            if (!currentPOData) {
                alert('No PO selected');
                return;
            }
            
            const comment = document.getElementById('new-po-note').value.trim();
            if (!comment) {
                alert('Please enter a comment');
                return;
            }
            
            fetch('/api/po-notes/save', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    po_id: currentPOData.po_id,
                    order_id: currentPOData.order_id,
                    comment: comment
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Clear the textarea
                    document.getElementById('new-po-note').value = '';
                    
                    // Reload notes
                    loadPONotes(currentPOData.po_id);
                } else {
                    alert('Error saving PO note: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error saving PO note:', error);
                alert('Error saving PO note. Please try again.');
            });
        }
        
        function deletePONote(noteId) {
            if (!confirm('Are you sure you want to delete this PO note?')) {
                return;
            }
            
            fetch(`/api/notes/${noteId}/delete`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'include'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Reload notes to reflect the deletion
                    if (currentPOData) {
                        loadPONotes(currentPOData.po_id);
                    }
                } else {
                    alert('Error deleting PO note: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error deleting PO note:', error);
                alert('Error deleting PO note. Please try again.');
            });
        }
        
        // Debounce mechanism to prevent rapid clicks
        let clickTimeout = null;
        
        function showComparisonItemDetails(poItemId, poId, sku, productName, changeLog, netoQtyAvailable, originalRexQtyOrdered, netoQtyShipped, finalRexQtyOrdered, rexQtyReceived) {
            console.log('showComparisonItemDetails called with:', {poItemId, poId, sku});
            
            // Clear any existing timeout
            if (clickTimeout) {
                clearTimeout(clickTimeout);
            }
            
            // Debounce the function call
            clickTimeout = setTimeout(() => {
                try {
                    // Check if poItemId is valid
                    if (!poItemId || poItemId === 'undefined' || poItemId === 'null' || poItemId === 'None') {
                        console.error('Invalid poItemId:', poItemId);
                        return;
                    }
                    
                    console.log('Processing click for item:', {poItemId, poId, sku});
                    
                    // Store current comparison item data
                    currentItemData = {
                        po_item_id: poItemId,
                        po_id: poId,
                        sku: sku,
                        product_name: productName,
                        change_log: changeLog,
                        neto_qty_available: netoQtyAvailable,
                        original_rex_qty_ordered: originalRexQtyOrdered,
                        neto_qty_shipped: netoQtyShipped,
                        final_rex_qty_ordered: finalRexQtyOrdered,
                        rex_qty_received: rexQtyReceived
                    };
                    
                    // Show item details panel and left panel for notes
                    const quickInfoPanel = document.getElementById('quick-info-panel');
                    const itemDetailsPanel = document.getElementById('item-details-panel');
                    
                    if (quickInfoPanel) quickInfoPanel.style.display = 'none';
                    showRightPanel(); // Show right panel with proper class management
                    if (itemDetailsPanel) itemDetailsPanel.style.display = 'block';
                    showLeftPanel(); // Show left panel for notes
                    
                    // Clear the notes area first to prevent showing old notes
                    const notesList = document.getElementById('notes-list');
                    if (notesList) {
                        notesList.innerHTML = `
                            <div class="text-center text-muted">
                                <small>Loading notes...</small>
                            </div>
                        `;
                    }
                    
                    // Clear the note input
                    const newNoteInput = document.getElementById('new-note');
                    if (newNoteInput) newNoteInput.value = '';
                    
                    // Populate item info header
                    populateComparisonItemInfoHeader();
                    
                    // Load existing notes with a small delay to ensure DOM is updated
                    console.log('Loading notes for poItemId:', poItemId);
                    console.log('Current currentItemData before loading notes:', currentItemData);
                    setTimeout(() => {
                        loadItemNotes(poItemId);
                    }, 150);
                    
                } catch (error) {
                    console.error('Error in showComparisonItemDetails:', error);
                }
            }, 50); // 50ms debounce
        }
        
        function showItemDetails(poItemId, poId, sku, productName, netoQtyAvailable, netoQtyOrdered, rexQtyOrdered, rexQtyReceived, netoCostPrice, rexSupplierBuyEx, difference, disparity) {
            // Store current item data
            currentItemData = {
                po_item_id: poItemId,
                po_id: poId,
                sku: sku,
                product_name: productName,
                neto_qty_available: netoQtyAvailable,
                neto_qty_ordered: netoQtyOrdered,
                rex_qty_ordered: rexQtyOrdered,
                rex_qty_received: rexQtyReceived,
                neto_cost_price: netoCostPrice,
                rex_supplier_buy_ex: rexSupplierBuyEx,
                difference: difference,
                disparity: disparity
            };
            
            // Ensure currentPOData is set (at minimum with po_id)
            if (!currentPOData || currentPOData.po_id !== poId) {
                currentPOData = {
                    po_id: poId,
                    order_id: null
                };
            }
            
            // Show item details panel in the right sidebar
            document.getElementById('quick-info-panel').style.display = 'none';
            document.getElementById('item-details-panel').style.display = 'block';
            
            // Clear the notes area first to prevent showing old notes
            document.getElementById('notes-list').innerHTML = `
                <div class="text-center text-muted">
                    <small>Loading notes...</small>
                </div>
            `;
            
            // Clear the note input
            document.getElementById('new-note').value = '';
            
            // Populate item info header
            populateItemInfoHeader();
            
            // Load existing notes
            loadItemNotes(poItemId);
        }
        
        function closeItemDetails() {
            // Hide item details panel - keep Quick Info hidden in REX PO Orders view
            const detailsPanel = document.getElementById('item-details-panel');
            if (detailsPanel) {
                detailsPanel.style.display = 'none';
            }
            hideRightPanel();
            
            // Clear current item data
            currentItemData = null;
            
            // Clear notes
            document.getElementById('notes-list').innerHTML = `
                <div class="text-center text-muted">
                    <small>No notes yet. Click on an item to add notes.</small>
                </div>
            `;
        }
        
        function populateComparisonItemInfoHeader() {
            if (!currentItemData) return;

            // Create colored badge for change log
            const changeLog = currentItemData.change_log || '-';
            let changeLogBadge = changeLog;
            if (changeLog !== '-') {
                let badgeClass = 'badge bg-secondary'; // default
                if (changeLog.toLowerCase().includes('receival')) {
                    badgeClass = 'badge bg-warning text-dark';
                } else if (changeLog.toLowerCase().includes('quantity')) {
                    badgeClass = 'badge bg-info';
                } else if (changeLog.toLowerCase().includes('price')) {
                    badgeClass = 'badge bg-danger';
                } else if (changeLog.toLowerCase().includes('difference')) {
                    badgeClass = 'badge bg-primary';
                } else if (changeLog.toLowerCase().includes('new')) {
                    badgeClass = 'badge bg-success';
                } else if (changeLog.toLowerCase().includes('removed')) {
                    badgeClass = 'badge bg-danger';
                } else if (changeLog.toLowerCase().includes('unchanged')) {
                    badgeClass = 'badge bg-light text-dark';
                }
                changeLogBadge = `<span class="${badgeClass}">${changeLog}</span>`;
            }

            const infoHeader = document.getElementById('item-info-header');
            infoHeader.innerHTML = `
                <div class="table-responsive">
                    <table class="table table-sm" style="font-size: 0.9em; border-collapse: separate; border-spacing: 0;">
                        <tbody>
                            <tr style="background-color: #f8f9fa;">
                                <td class="fw-bold" style="width: 40%; padding: 8px 12px; border-bottom: 1px solid #dee2e6;">PO ID</td>
                                <td style="padding: 8px 12px; border-bottom: 1px solid #dee2e6;">${currentItemData.po_id}</td>
                            </tr>
                            <tr style="background-color: #ffffff;">
                                <td class="fw-bold" style="padding: 8px 12px; border-bottom: 1px solid #dee2e6;">PO Item ID</td>
                                <td style="padding: 8px 12px; border-bottom: 1px solid #dee2e6;">${currentItemData.po_item_id}</td>
                            </tr>
                            <tr style="background-color: #f8f9fa;">
                                <td class="fw-bold" style="padding: 8px 12px; border-bottom: 1px solid #dee2e6;">SKU</td>
                                <td style="padding: 8px 12px; border-bottom: 1px solid #dee2e6;">${currentItemData.sku}</td>
                            </tr>
                            <tr style="background-color: #ffffff;">
                                <td class="fw-bold" style="padding: 8px 12px; border-bottom: 1px solid #dee2e6;">Product</td>
                                <td style="padding: 8px 12px; border-bottom: 1px solid #dee2e6;">${currentItemData.product_name}</td>
                            </tr>
                            <tr style="background-color: #f8f9fa;">
                                <td class="fw-bold" style="padding: 8px 12px; border-bottom: 1px solid #dee2e6;">Change Log</td>
                                <td style="padding: 8px 12px; border-bottom: 1px solid #dee2e6;">${changeLogBadge}</td>
                            </tr>
                            <tr style="background-color: #ffffff;">
                                <td class="fw-bold" style="padding: 8px 12px; border-bottom: 1px solid #dee2e6;">NETO Qty Available</td>
                                <td style="padding: 8px 12px; border-bottom: 1px solid #dee2e6;">${currentItemData.neto_qty_available || '-'}</td>
                            </tr>
                            <tr style="background-color: #f8f9fa;">
                                <td class="fw-bold" style="padding: 8px 12px; border-bottom: 1px solid #dee2e6;">Original REX Qty Ordered</td>
                                <td style="padding: 8px 12px; border-bottom: 1px solid #dee2e6;">${currentItemData.original_rex_qty_ordered || '-'}</td>
                            </tr>
                            <tr style="background-color: #ffffff;">
                                <td class="fw-bold" style="padding: 8px 12px; border-bottom: 1px solid #dee2e6;">NETO Qty Invoiced</td>
                                <td style="padding: 8px 12px; border-bottom: 1px solid #dee2e6;">${currentItemData.neto_qty_shipped || '-'}</td>
                            </tr>
                            <tr style="background-color: #f8f9fa;">
                                <td class="fw-bold" style="padding: 8px 12px; border-bottom: 1px solid #dee2e6;">REX Qty Received</td>
                                <td style="padding: 8px 12px; border-bottom: 1px solid #dee2e6;">${currentItemData.rex_qty_received || '-'}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        function populateItemInfoHeader() {
            if (!currentItemData) return;
            
            const infoHeader = document.getElementById('item-info-header');
            infoHeader.innerHTML = `
                <div class="row">
                    <div class="col-3"><strong>PO ID:</strong></div>
                    <div class="col-9">${currentItemData.po_id}</div>
                </div>
                <div class="row mt-1">
                    <div class="col-3"><strong>SKU:</strong></div>
                    <div class="col-9">${currentItemData.sku}</div>
                </div>
                <div class="row mt-1">
                    <div class="col-3"><strong>Product:</strong></div>
                    <div class="col-9">${currentItemData.product_name}</div>
                </div>
            `;
            
            // Also populate SKU badge in Add Comment section
            const skuBadge = document.getElementById('item-sku-badge');
            if (skuBadge) {
                skuBadge.textContent = `SKU: ${currentItemData.sku}`;
            }
        }
        
        function loadItemNotes(poItemId) {
            console.log('loadItemNotes called with poItemId:', poItemId);
            
            // Validate poItemId
            if (!poItemId || poItemId === 'undefined' || poItemId === 'null' || poItemId === 'None') {
                console.error('Invalid poItemId in loadItemNotes:', poItemId);
                displayNotes([]);
                return;
            }
            
            fetch(`/api/notes/${poItemId}`, {
                credentials: 'include'
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Notes API response:', data);
                    if (data.success) {
                        console.log('Displaying notes:', data.notes);
                        displayNotes(data.notes);
                    } else {
                        console.error('Error loading notes:', data.error);
                        displayNotes([]);
                    }
                })
                .catch(error => {
                    console.error('Error loading notes:', error);
                    displayNotes([]);
                });
        }
        
        function displayNotes(notes) {
            console.log('displayNotes called with:', notes);
            const notesList = document.getElementById('notes-list');
            console.log('notesList element:', notesList);
            
            if (!notesList) {
                console.error('notes-list element not found');
                return;
            }
            
            if (!notes || notes.length === 0) {
                console.log('No notes found, showing empty state');
                notesList.innerHTML = `
                    <div class="text-center text-muted">
                        <small>No notes yet. Add a comment below.</small>
                    </div>
                `;
                return;
            }
            
            console.log('Building notes HTML for', notes.length, 'notes');
            
            let notesHTML = '';
            notes.forEach(note => {
                const timestamp = new Date(note.created_at).toLocaleString('en-AU', {
                    timeZone: 'Australia/Melbourne',
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                notesHTML += `
                    <div class="note-item-card">
                        <div class="note-item-header">
                            <span class="note-sku">${note.username}</span>
                            <button class="note-delete-btn" onclick="deleteNote('${note.note_id}')" title="Delete note">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        <p class="note-body">${note.comment}</p>
                        <div class="note-footer">
                            <span><i class="fas fa-clock me-1"></i>${timestamp}</span>
                            <span>ID: ${note.note_id}</span>
                        </div>
                    </div>
                `;
            });
            
            console.log('Setting notesList.innerHTML with HTML length:', notesHTML.length);
            console.log('HTML preview:', notesHTML.substring(0, 200) + '...');
            notesList.innerHTML = notesHTML;
            console.log('notesList.innerHTML set successfully');
        }
        
        function deleteNote(noteId) {
            if (!confirm('Are you sure you want to delete this note?')) {
                return;
            }
            
            if (!currentItemData || !currentItemData.po_item_id || !currentItemData.po_id) {
                alert('Error: Missing item information');
                return;
            }
            
            // Freeze UI - disable all buttons and show loading state
            const deleteButtons = document.querySelectorAll('.delete-note-btn');
            const saveButton = document.getElementById('save-note-btn');
            const noteTextarea = document.getElementById('new-note');
            
            deleteButtons.forEach(btn => btn.disabled = true);
            if (saveButton) saveButton.disabled = true;
            if (noteTextarea) noteTextarea.disabled = true;
            
            // Show loading overlay
            const notesSection = document.getElementById('item-notes-list');
            if (notesSection) {
                notesSection.style.opacity = '0.5';
                notesSection.style.pointerEvents = 'none';
            }
            
            fetch(`/api/notes/${noteId}/delete`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'include',
                body: JSON.stringify({
                    po_item_id: currentItemData.po_item_id,
                    po_id: currentItemData.po_id
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('Note deleted and cache updated successfully');
                    
                    // Reload notes to reflect the deletion
                    if (currentItemData) {
                        loadItemNotes(currentItemData.po_item_id);
                        
                        // Update the Latest Note column in Comparison table
                        updateComparisonTableAfterNoteChange(currentItemData.po_item_id);
                    }
                } else {
                    alert('Error deleting note: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error deleting note:', error);
                alert('Error deleting note. Please try again.');
            })
            .finally(() => {
                // Unfreeze UI after completion
                deleteButtons.forEach(btn => btn.disabled = false);
                if (saveButton) saveButton.disabled = false;
                if (noteTextarea) noteTextarea.disabled = false;
                
                // Remove loading overlay
                if (notesSection) {
                    notesSection.style.opacity = '1';
                    notesSection.style.pointerEvents = 'auto';
                }
            });
        }
        
        function saveNote() {
            if (!currentItemData) {
                alert('No item selected');
                return;
            }
            
            const comment = document.getElementById('new-note').value.trim();
            if (!comment) {
                alert('Please enter a comment');
                return;
            }
            
            const noteData = {
                po_item_id: currentItemData.po_item_id,
                po_id: currentItemData.po_id,
                sku: currentItemData.sku,
                comment: comment
            };
            
            // Show loading indicator
            const saveButton = document.querySelector('button[onclick="saveNote()"]');
            const originalText = saveButton.textContent;
            saveButton.textContent = 'Saving...';
            saveButton.disabled = true;
            
            fetch('/api/notes/save', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(noteData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update the Latest Note column in Comparison table immediately
                    updateComparisonTableLatestNote(currentItemData.po_item_id, comment, 'admin', new Date().toISOString());
                    
                    // Close item details panel
                    document.getElementById('item-details-panel').style.display = 'none';
                    
                    // Show All Notes card for the PO (if not already visible)
                    if (currentPOData && currentPOData.po_id) {
                        const allItemNotesCard = document.getElementById('allItemNotesCard');
                        if (allItemNotesCard) {
                            allItemNotesCard.style.display = 'block';
                        }
                        
                        // Reload all item notes for the PO
                        loadAllItemNotesForPO(currentPOData.po_id);
                    }
                } else {
                    alert('Error saving note: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error saving note:', error);
                alert('Error saving note. Please try again.');
            })
            .finally(() => {
                // Restore button state
                saveButton.textContent = originalText;
                saveButton.disabled = false;
            });
        }
        
        function updateComparisonTableAfterNoteChange(poItemId) {
            // Fetch the latest note for this item to update the comparison table
            fetch(`/api/notes/${poItemId}`, {
                credentials: 'include'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.notes && data.notes.length > 0) {
                    // Get the latest note (first in the array, as they're sorted by date desc)
                    const latestNote = data.notes[0];
                    updateComparisonTableLatestNote(poItemId, latestNote.comment, latestNote.user, latestNote.created_at);
                } else {
                    // No notes, show dash
                    updateComparisonTableLatestNote(poItemId, null);
                }
            })
            .catch(error => {
                console.error('Error fetching latest note:', error);
                // On error, show dash
                updateComparisonTableLatestNote(poItemId, null);
            });
        }
        
        function updateComparisonTableLatestNote(poItemId, newNote, user = 'admin', date = null) {
            console.log('updateComparisonTableLatestNote called with:', {poItemId, newNote, user, date});
            
            // Find the row in the comparison table that matches the po_item_id
            const comparisonTable = document.querySelector('#comparisonContainer table tbody');
            if (!comparisonTable) {
                console.log('comparisonTable not found');
                return;
            }
            
            const rows = comparisonTable.querySelectorAll('tr');
            console.log(`Found ${rows.length} rows in comparison table`);
            
            rows.forEach((row, index) => {
                // Check if this row has the matching po_item_id in its data attribute
                const rowPoItemId = row.getAttribute('data-po-item-id');
                console.log(`Row ${index} data-po-item-id:`, rowPoItemId);
                
                if (rowPoItemId === poItemId) {
                    console.log(`Found matching row for poItemId ${poItemId}`);
                    // Find the Latest Note cell (last cell in the row)
                    const cells = row.querySelectorAll('td');
                    if (cells.length > 0) {
                        const latestNoteCell = cells[cells.length - 1]; // Last cell is Latest Note
                        
                        if (newNote) {
                            // Format the date
                            const formattedDate = date ? new Date(date).toLocaleDateString('en-AU') : new Date().toLocaleDateString('en-AU');
                            
                            // Update the Latest Note cell with the new note
                            latestNoteCell.innerHTML = `
                                <div class="text-truncate" style="max-width: 200px;" title="${newNote} - ${user} (${formattedDate})">
                                    <small class="text-muted">${user}:</small> ${newNote}
                                </div>
                            `;
                        } else {
                            // No note, show dash
                            latestNoteCell.innerHTML = '<span class="text-muted">-</span>';
                        }
                    }
                    return; // Exit the forEach loop once we find the matching row
                }
            });
        }
        
        // Allow Enter key to save note
        document.addEventListener('DOMContentLoaded', function() {
            const newNoteTextarea = document.getElementById('new-note');
            if (newNoteTextarea) {
                newNoteTextarea.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && e.ctrlKey) {
                        e.preventDefault();
                        saveNote();
                    }
                });
            }
        });
        
        function toggleUserDropdown(event) {
            event.stopPropagation();
            const dropdown = document.getElementById('userDropdown');
            if (dropdown) {
                dropdown.classList.toggle('open');
            }
        }
        
        document.addEventListener('click', function(e) {
            const dropdown = document.getElementById('userDropdown');
            if (dropdown && !dropdown.contains(e.target)) {
                dropdown.classList.remove('open');
            }
        });
        
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const dropdown = document.getElementById('userDropdown');
                if (dropdown) dropdown.classList.remove('open');
            }
        });
        
        // Resizable Sidebars
        let isResizingRight = false;
        let isResizingLeft = false;
        let startX = 0;
        let startWidth = 0;
        
        function initResizableSidebar() {
            const resizeHandle = document.getElementById('resize-handle');
            const rightPanel = document.getElementById('right-panel');
            const contentArea = document.querySelector('.content-area');
            const root = document.documentElement;
            
            if (!resizeHandle || !rightPanel || !contentArea) return;
            
            resizeHandle.addEventListener('mousedown', function(e) {
                isResizingRight = true;
                startX = e.clientX;
                startWidth = parseInt(window.getComputedStyle(rightPanel).width, 10);
                
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';
                
                e.preventDefault();
            });
            
            document.addEventListener('mousemove', function(e) {
                if (!isResizingRight) return;
                
                const newWidth = startWidth - (e.clientX - startX);
                const minWidth = 300;
                const maxWidth = 600;
                
                if (newWidth >= minWidth && newWidth <= maxWidth) {
                    root.style.setProperty('--right-panel-width', newWidth + 'px');
                }
            });
            
            document.addEventListener('mouseup', function() {
                if (isResizingRight) {
                    isResizingRight = false;
                    document.body.style.cursor = '';
                    document.body.style.userSelect = '';
                    
                    // Save the width to localStorage
                    const currentWidth = parseInt(window.getComputedStyle(rightPanel).width, 10);
                    localStorage.setItem('rightPanelWidth', currentWidth);
                }
            });
            
            // Load saved width from localStorage
            const savedWidth = localStorage.getItem('rightPanelWidth');
            if (savedWidth) {
                const width = parseInt(savedWidth, 10);
                if (width >= 300 && width <= 600) {
                    root.style.setProperty('--right-panel-width', width + 'px');
                }
            }
        }
        
        // Helper functions to show/hide left panel with proper class management
        function showLeftPanel() {
            const leftPanel = document.querySelector('.left-panel');
            const mainContent = document.querySelector('.main-content');
            
            if (leftPanel) {
                leftPanel.classList.remove('hidden');
                leftPanel.style.display = 'block';
            }
            if (mainContent) {
                mainContent.classList.remove('left-panel-hidden');
                // Clear any inline styles that might interfere
                mainContent.style.marginLeft = '';
                mainContent.style.marginRight = '';
            }
        }
        
        function hideLeftPanel() {
            const leftPanel = document.querySelector('.left-panel');
            const mainContent = document.querySelector('.main-content');
            
            if (leftPanel) {
                leftPanel.classList.add('hidden');
                // Keep display: block but slide it out with transform
            }
            if (mainContent) {
                mainContent.classList.add('left-panel-hidden');
                // Clear any inline styles that might interfere
                mainContent.style.marginLeft = '';
                mainContent.style.marginRight = '';
            }
        }
        
        // Helper functions to show/hide right panel with proper class management
        function showRightPanel() {
            const rightPanel = document.getElementById('right-panel');
            const contentArea = document.querySelector('.content-area');
            
            if (rightPanel) {
                rightPanel.classList.remove('hidden');
                rightPanel.style.display = 'block';
            }
            if (contentArea) {
                contentArea.classList.remove('right-panel-hidden');
                // Clear any inline styles that might interfere
                contentArea.style.marginRight = '';
                contentArea.style.marginLeft = '';
                contentArea.style.width = '';
            }
        }
        
        function hideRightPanel() {
            const rightPanel = document.getElementById('right-panel');
            const contentArea = document.querySelector('.content-area');
            
            if (rightPanel) {
                rightPanel.classList.add('hidden');
                // Keep display: block but slide it out with transform
            }
            if (contentArea) {
                contentArea.classList.add('right-panel-hidden');
                // Clear any inline styles that might interfere
                contentArea.style.marginRight = '';
                contentArea.style.marginLeft = '';
                contentArea.style.width = '';
            }
        }

        function resetNotesPanels() {
            const notesList = document.getElementById('all-item-notes-list');
            const notesCount = document.getElementById('all-item-notes-count');
            if (notesList) {
                notesList.innerHTML = `
                    <div class="notes-placeholder">
                        <i class="fas fa-sticky-note fa-3x mb-3" style="opacity: 0.25;"></i>
                        <p class="mb-0">Select a purchase order from the summary table to view all item notes.</p>
                    </div>
                `;
            }
            if (notesCount) {
                notesCount.textContent = '0';
            }
            const itemDetailsPanel = document.getElementById('item-details-panel');
            if (itemDetailsPanel) {
                itemDetailsPanel.style.display = 'none';
            }
            const notesListRight = document.getElementById('notes-list');
            if (notesListRight) {
                notesListRight.innerHTML = `
                    <div class="text-center text-muted">
                        <small>No notes yet for this item.</small>
                    </div>
                `;
            }
            const poNotesList = document.getElementById('po-notes-list');
            if (poNotesList) {
                poNotesList.innerHTML = `
                    <div class="text-center text-muted">
                        <small>No PO notes yet. Add a comment below.</small>
                    </div>
                `;
            }
            currentItemData = null;
        }
        
        function initResizableLeftPanel() {
            const leftResizeHandle = document.querySelector('.left-resize-handle');
            const leftPanel = document.querySelector('.left-panel');
            const mainContent = document.querySelector('.main-content');
            const root = document.documentElement;
            
            if (!leftResizeHandle || !leftPanel || !mainContent) return;
            
            leftResizeHandle.addEventListener('mousedown', function(e) {
                isResizingLeft = true;
                startX = e.clientX;
                startWidth = parseInt(window.getComputedStyle(leftPanel).width, 10);
                
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';
                
                e.preventDefault();
            });
            
            document.addEventListener('mousemove', function(e) {
                if (!isResizingLeft) return;
                
                const newWidth = startWidth + (e.clientX - startX);
                const minWidth = 300;
                const maxWidth = 600;
                
                if (newWidth >= minWidth && newWidth <= maxWidth) {
                    root.style.setProperty('--left-panel-width', newWidth + 'px');
                }
            });
            
            document.addEventListener('mouseup', function() {
                if (isResizingLeft) {
                    isResizingLeft = false;
                    document.body.style.cursor = '';
                    document.body.style.userSelect = '';
                    
                    // Save the width to localStorage
                    const currentWidth = parseInt(window.getComputedStyle(leftPanel).width, 10);
                    localStorage.setItem('leftPanelWidth', currentWidth);
                }
            });
            
            // Load saved width from localStorage
            const savedWidth = localStorage.getItem('leftPanelWidth');
            if (savedWidth) {
                const width = parseInt(savedWidth, 10);
                if (width >= 300 && width <= 600) {
                    root.style.setProperty('--left-panel-width', width + 'px');
                }
            }
        }
        
        // Initialize resizable sidebars when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            initResizableSidebar();
            initResizableLeftPanel();
            initFlagReviewModal();
        });

        function initializeRetailPage() {
            updateSidebarCacheStatus();
            fetchRetailReviews();
        }

        function fetchRetailReviews() {
            fetch('/api/reviews/retail')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        renderRetailReviews(
                            data.awaiting_retail || [],
                            data.pending_warehouse || [],
                            data.completed_reviews || []
                        );
                    } else {
                        showRetailError(data.error || 'Unable to load retail reviews.');
                    }
                })
                .catch(error => {
                    showRetailError(error.message || 'Unable to load retail reviews.');
                });
        }

        function showRetailError(message) {
            const container = document.getElementById('retailReviewsContainer');
            if (!container) return;
            container.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle me-1"></i>${message}
                </div>
            `;
        }

        function renderRetailReviews(awaitingRetail, pendingWarehouse, completedReviews) {
            const container = document.getElementById('retailReviewsContainer');
            if (!container) return;

            const awaitingSection = `
                <div class="card mb-4">
                    <div class="card-header bg-light d-flex justify-content-between align-items-center flex-wrap gap-2">
                        <div>
                            <h5 class="mb-0"><i class="fas fa-clipboard-check me-2 text-success"></i>Warehouse Completed</h5>
                            <small class="text-muted">Review warehouse comments and mark as resolved.</small>
                        </div>
                        <span class="badge bg-primary">${awaitingRetail.length}</span>
                    </div>
                    <div class="card-body p-0">
                        ${awaitingRetail.length ? buildRetailTable(awaitingRetail, { section: 'awaiting' }) : '<div class="p-4 text-center text-muted">No warehouse-completed reviews waiting on retail.</div>'}
                    </div>
                </div>
            `;

            const pendingSection = `
                <div class="card mb-4">
                    <div class="card-header bg-light d-flex justify-content-between align-items-center flex-wrap gap-2">
                        <div>
                            <h5 class="mb-0"><i class="fas fa-hourglass-half me-2 text-warning"></i>Pending Warehouse</h5>
                            <small class="text-muted">Warehouse has not responded yet.</small>
                        </div>
                        <span class="badge bg-warning text-dark">${pendingWarehouse.length}</span>
                    </div>
                    <div class="card-body p-0">
                        ${pendingWarehouse.length ? buildRetailTable(pendingWarehouse, { section: 'pending' }) : '<div class="p-4 text-center text-muted">No pending warehouse reviews.</div>'}
                    </div>
                </div>
            `;

            const completedSection = `
                <div class="card mb-4">
                    <div class="card-header bg-light d-flex justify-content-between align-items-center flex-wrap gap-2">
                        <div>
                            <h5 class="mb-0"><i class="fas fa-check-double me-2 text-success"></i>Completed Reviews</h5>
                            <small class="text-muted">Recently resolved by retail.</small>
                        </div>
                        <span class="badge bg-success">${completedReviews.length}</span>
                    </div>
                    <div class="card-body p-0">
                        ${completedReviews.length ? buildRetailTable(completedReviews, { section: 'completed' }) : '<div class="p-4 text-center text-muted">No completed reviews yet.</div>'}
                    </div>
                </div>
            `;

            container.innerHTML = `
                ${awaitingSection}
                ${pendingSection}
                ${completedSection}
            `;
            attachRetailRowHandlers();
        }

        function buildRetailTable(reviews, options = {}) {
            const sectionAttr = options.section ? ` data-section="${options.section}"` : '';
            const rows = reviews.map(review => {
                const changeInfo = getChangeLogDisplay(getReviewChangeLog(review));
                const comment = review.flag_comment ? `<div class="text-wrap">${escapeHtml(review.flag_comment)}</div>` : '<span class="text-muted">-</span>';
                const productName = escapeHtml(getReviewProductName(review) || '-');
                const orderIdLabel = review.order_id ? escapeHtml(review.order_id) : null;
                const orderUrlId = review.order_id ? encodeURIComponent(review.order_id) : null;
                const orderLink = orderIdLabel ? `<a href="https://www.chainsawspares.com.au/_cpanel/order/vieworder?id=${orderUrlId}" target="_blank" onclick="event.stopPropagation();">${orderIdLabel}</a>` : '-';
                const poIdDisplay = escapeHtml(review.po_id || '-');
                const skuDisplay = escapeHtml(review.sku || '-');
                const flaggedBy = escapeHtml(review.flagged_by || '-');
                const statusBadge = formatReviewBadge(review.status);
                const warehouseIndicator = review.warehouse_comment ? '<i class="fas fa-clipboard-check text-success ms-1" title="Warehouse has responded."></i>' : '';
                const reviewDataAttr = encodeURIComponent(JSON.stringify(review));
                return `
                    <tr class="retail-review-row" data-review="${reviewDataAttr}"${sectionAttr}>
                        <td class="text-center">${poIdDisplay}</td>
                        <td class="text-center">${orderLink}</td>
                        <td class="text-center">${skuDisplay}</td>
                        <td>${productName}</td>
                        <td><span class="badge ${changeInfo.badgeClass}">${changeInfo.label}</span></td>
                        <td>${flaggedBy}</td>
                        <td>${comment}</td>
                        <td class="text-center">${statusBadge} ${warehouseIndicator}</td>
                    </tr>
                `;
            }).join('');
            return `
                <div style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-striped table-hover mb-0 warehouse-table">
                        <thead class="table-light position-sticky top-0">
                            <tr>
                                <th class="text-center">PO ID</th>
                                <th class="text-center">Order ID</th>
                                <th class="text-center">SKU</th>
                                <th>Item</th>
                                <th>Change Log</th>
                                <th>Flagged By</th>
                                <th>Comment</th>
                                <th class="text-center">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rows}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function attachRetailRowHandlers() {
            document.querySelectorAll('.retail-review-row').forEach(row => {
                row.addEventListener('click', () => {
                    const reviewData = row.getAttribute('data-review');
                    if (!reviewData) return;
                    try {
                        const review = JSON.parse(decodeURIComponent(reviewData));
                        openRetailReviewModal(review);
                    } catch (error) {
                        console.error('Failed to parse review data for retail modal', error);
                    }
                });
            });
        }

        let retailModalInstance = null;
        let currentRetailReview = null;

        function ensureRetailModal() {
            if (retailModalInstance || typeof bootstrap === 'undefined') return;
            const modalEl = document.getElementById('retailReviewModal');
            if (modalEl) {
                retailModalInstance = new bootstrap.Modal(modalEl);
                const resolveBtn = document.getElementById('retailResolveBtn');
                if (resolveBtn) {
                    resolveBtn.addEventListener('click', submitRetailResolve);
                }
                const commentInput = document.getElementById('retailResolutionComment');
                if (commentInput) {
                    commentInput.addEventListener('input', updateRetailCommentCounter);
                }
                modalEl.addEventListener('hidden.bs.modal', () => {
                    currentRetailReview = null;
                    const textarea = document.getElementById('retailResolutionComment');
                    if (textarea) {
                        textarea.value = '';
                        textarea.disabled = false;
                    }
                    updateRetailCommentCounter();
                    toggleRetailModalLoading(false);
                    showRetailModalWarning(null);
                });
            }
        }

        function openRetailReviewModal(review) {
            ensureRetailModal();
            if (!retailModalInstance) return;
            currentRetailReview = review;
            populateRetailModal(review);
            retailModalInstance.show();
        }

        function populateRetailModal(review) {
            const reviewIdEl = document.getElementById('retailDetailReviewId');
            if (reviewIdEl) reviewIdEl.textContent = review.review_id || '-';
            const poEl = document.getElementById('retailDetailPoId');
            if (poEl) poEl.textContent = review.po_id || '-';
            const orderEl = document.getElementById('retailDetailOrderId');
            if (orderEl) {
                if (review.order_id) {
                    const safeOrderId = escapeHtml(review.order_id);
                    const orderUrlId = encodeURIComponent(review.order_id);
                    orderEl.innerHTML = `<a href="https://www.chainsawspares.com.au/_cpanel/order/vieworder?id=${orderUrlId}" target="_blank">${safeOrderId}</a>`;
                } else {
                    orderEl.textContent = '-';
                }
            }
            const itemIdEl = document.getElementById('retailDetailItemId');
            if (itemIdEl) itemIdEl.textContent = review.po_item_id || '-';
            const skuEl = document.getElementById('retailDetailSku');
            if (skuEl) skuEl.textContent = review.sku || '-';
            const productEl = document.getElementById('retailDetailProduct');
            if (productEl) productEl.textContent = getReviewProductName(review);
            const changeInfo = getChangeLogDisplay(getReviewChangeLog(review));
            const changeEl = document.getElementById('retailDetailChange');
            if (changeEl) changeEl.innerHTML = `<span class="badge ${changeInfo.badgeClass}">${changeInfo.label}</span>`;
            const statusEl = document.getElementById('retailDetailStatus');
            if (statusEl) statusEl.innerHTML = formatReviewBadge(review.status);
            const flaggedByEl = document.getElementById('retailDetailFlaggedBy');
            if (flaggedByEl) flaggedByEl.textContent = review.flagged_by || '-';
            const flaggedAtEl = document.getElementById('retailDetailFlaggedAt');
            if (flaggedAtEl) flaggedAtEl.textContent = formatLocalDateTime(review.flagged_at);
            const flagCommentEl = document.getElementById('retailDetailFlagComment');
            if (flagCommentEl) flagCommentEl.textContent = review.flag_comment || '';

            const snapshot = getReviewSnapshot(review);
            const latestNoteEl = document.getElementById('retailDetailLatestNote');
            if (latestNoteEl) {
                latestNoteEl.textContent = snapshot && snapshot.latest_item_note
                    ? `${snapshot.latest_item_note_user || 'User'}: ${snapshot.latest_item_note}`
                    : '';
            }
            renderReviewStatGrid(snapshot, 'retailDetailStats');

            const warehouseCommentEl = document.getElementById('retailWarehouseComment');
            if (warehouseCommentEl) {
                warehouseCommentEl.textContent = review.warehouse_comment || 'Warehouse has not provided feedback yet.';
            }
            const warehouseMetaEl = document.getElementById('retailWarehouseMeta');
            if (warehouseMetaEl) {
                if (review.warehouse_comment) {
                    const parts = [];
                    if (review.warehouse_assigned_to) {
                        parts.push(`By ${review.warehouse_assigned_to}`);
                    }
                    if (review.warehouse_closed_at) {
                        parts.push(`on ${formatLocalDateTime(review.warehouse_closed_at)}`);
                    }
                    warehouseMetaEl.textContent = parts.length ? parts.join('  ') : 'Warehouse response recorded.';
                } else {
                    warehouseMetaEl.textContent = 'Waiting on warehouse response.';
                }
            }

            const commentInput = document.getElementById('retailResolutionComment');
            if (commentInput) {
                commentInput.value = review.retail_comment || '';
                commentInput.disabled = review.status !== 'warehouse_closed';
            }
            updateRetailCommentCounter();

            const resolveBtn = document.getElementById('retailResolveBtn');
            if (resolveBtn) {
                if (review.status === 'warehouse_closed') {
                    resolveBtn.classList.remove('d-none');
                    resolveBtn.disabled = false;
                } else {
                    resolveBtn.classList.add('d-none');
                }
            }

            const modalInfo = document.getElementById('retailModalInfo');
            if (modalInfo) {
                modalInfo.classList.add('d-none');
                modalInfo.textContent = '';
                modalInfo.classList.remove('alert-info', 'alert-warning', 'alert-success');
                if (review.status === 'warehouse_closed') {
                    modalInfo.classList.remove('d-none');
                    modalInfo.classList.add('alert-info');
                    modalInfo.innerHTML = '<i class="fas fa-info-circle me-1"></i>Warehouse has responded. Add optional notes and mark as resolved.';
                } else if (review.status === 'pending' || review.status === 'warehouse_in_progress') {
                    modalInfo.classList.remove('d-none');
                    modalInfo.classList.add('alert-warning');
                    modalInfo.innerHTML = '<i class="fas fa-hourglass-half me-1"></i>Waiting on warehouse to complete this review.';
                }
            }

            const resolvedMeta = document.getElementById('retailResolvedMeta');
            if (resolvedMeta) {
                if (review.status === 'retail_closed') {
                    resolvedMeta.classList.remove('d-none');
                    resolvedMeta.innerHTML = `<i class="fas fa-check-circle me-1"></i>Resolved by ${escapeHtml(review.retail_closed_by || 'Retail')} on ${formatLocalDateTime(review.retail_closed_at)}.`;
                } else {
                    resolvedMeta.classList.add('d-none');
                    resolvedMeta.textContent = '';
                }
            }

            showRetailModalWarning(null);
            toggleRetailModalLoading(false);
        }

        function updateRetailCommentCounter() {
            const textarea = document.getElementById('retailResolutionComment');
            const counter = document.getElementById('retailCommentCharCount');
            if (!textarea || !counter) return;
            counter.textContent = textarea.value.length;
        }

        function toggleRetailModalLoading(isLoading) {
            const btn = document.getElementById('retailResolveBtn');
            if (!btn) return;
            const defaultLabel = btn.querySelector('.default-label');
            const loadingLabel = btn.querySelector('.loading-label');
            btn.disabled = isLoading;
            if (defaultLabel && loadingLabel) {
                if (isLoading) {
                    defaultLabel.classList.add('d-none');
                    loadingLabel.classList.remove('d-none');
                } else {
                    defaultLabel.classList.remove('d-none');
                    loadingLabel.classList.add('d-none');
                }
            }
        }

        function showRetailModalWarning(message) {
            const warning = document.getElementById('retailDetailWarning');
            if (!warning) return;
            if (message) {
                warning.classList.remove('d-none');
                warning.textContent = message;
            } else {
                warning.classList.add('d-none');
                warning.textContent = '';
            }
        }

        function submitRetailResolve() {
            if (!currentRetailReview) return;
            if (currentRetailReview.status !== 'warehouse_closed') {
                showRetailModalWarning('Only warehouse-completed reviews can be resolved.');
                return;
            }
            const commentInput = document.getElementById('retailResolutionComment');
            const comment = commentInput ? commentInput.value.trim() : '';
            toggleRetailModalLoading(true);
            showRetailModalWarning(null);
            fetch(`/api/reviews/${currentRetailReview.review_id}/retail-close`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ comment })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    retailModalInstance.hide();
                    fetchRetailReviews();
                } else {
                    showRetailModalWarning(data.error || 'Failed to update review.');
                }
            })
            .catch(error => {
                showRetailModalWarning(error.message || 'Failed to update review.');
            })
            .finally(() => {
                toggleRetailModalLoading(false);
            });
        }

        function initializeWarehousePage() {
            updateSidebarCacheStatus();
            fetchWarehouseReviews();
        }

        function fetchWarehouseReviews() {
            fetch('/api/reviews')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        renderWarehouseReviews(data.open_reviews || [], data.closed_reviews || []);
                    } else {
                        showWarehouseError(data.error || 'Unable to load reviews.');
                    }
                })
                .catch(error => {
                    showWarehouseError(error.message || 'Unable to load reviews.');
                });
        }

        function showWarehouseError(message) {
            const container = document.getElementById('warehouseReviewsContainer');
            if (!container) return;
            container.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle"></i> ${message}
                </div>
            `;
        }

        function renderWarehouseReviews(openReviews, closedReviews) {
            const container = document.getElementById('warehouseReviewsContainer');
            if (!container) return;
            
            const openSection = `
                <div class="card mb-4">
                    <div class="card-header bg-light d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-inbox me-2"></i>Open Reviews</h5>
                        <span class="badge bg-primary">${openReviews.length}</span>
                    </div>
                    <div class="card-body p-0">
                        ${openReviews.length ? buildWarehouseTable(openReviews, true) : '<div class="p-4 text-center text-muted">No open reviews </div>'}
                    </div>
                </div>
            `;
            
            const closedSection = `
                <div class="card mb-4">
                    <div class="card-header bg-light d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-archive me-2"></i>Recently Closed</h5>
                        <span class="badge bg-secondary">${closedReviews.length}</span>
                    </div>
                    <div class="card-body p-0">
                        ${closedReviews.length ? buildWarehouseTable(closedReviews, false) : '<div class="p-4 text-center text-muted">No closed reviews yet.</div>'}
                    </div>
                </div>
            `;
            
            container.innerHTML = `
                ${openSection}
                ${closedSection}
            `;
            attachWarehouseRowHandlers();
        }

        function getReviewProductName(review) {
            if (review.product_name) return review.product_name;
            const snapshot = getReviewSnapshot(review);
            if (snapshot && snapshot.name) {
                return snapshot.name;
            }
            return '-';
        }

        function getReviewChangeLog(review) {
            if (review.change_log) return review.change_log;
            const snapshot = getReviewSnapshot(review);
            if (snapshot && snapshot.change_log) {
                return snapshot.change_log;
            }
            return 'Unknown';
        }

        function getReviewSnapshot(review) {
            if (!review || !review.comparison_snapshot) return null;
            if (review._parsedSnapshot) return review._parsedSnapshot;
            try {
                const snapshot = typeof review.comparison_snapshot === 'string'
                    ? JSON.parse(review.comparison_snapshot)
                    : review.comparison_snapshot;
                review._parsedSnapshot = snapshot;
                return snapshot;
            } catch (error) {
                console.warn('Unable to parse comparison snapshot for review', review.review_id);
                return null;
            }
        }

        function buildWarehouseTable(reviews, isOpen) {
            const rows = reviews.map(review => {
                const changeInfo = getChangeLogDisplay(getReviewChangeLog(review));
                const comment = review.flag_comment ? `<div class="text-wrap">${escapeHtml(review.flag_comment)}</div>` : '<span class="text-muted">-</span>';
                const productName = escapeHtml(getReviewProductName(review) || '-');
                const orderIdLabel = review.order_id ? escapeHtml(review.order_id) : null;
                const orderUrlId = review.order_id ? encodeURIComponent(review.order_id) : null;
                const orderLink = orderIdLabel ? `<a href="https://www.chainsawspares.com.au/_cpanel/order/vieworder?id=${orderUrlId}" target="_blank" onclick="event.stopPropagation();">${orderIdLabel}</a>` : '-';
                const poIdDisplay = escapeHtml(review.po_id || '-');
                const skuDisplay = escapeHtml(review.sku || '-');
                const flaggedBy = escapeHtml(review.flagged_by || '-');
                const reviewDataAttr = encodeURIComponent(JSON.stringify(review));
                return `
                    <tr class="warehouse-review-row" data-review="${reviewDataAttr}">
                        <td class="text-center">${poIdDisplay}</td>
                        <td class="text-center">${orderLink}</td>
                        <td class="text-center">${skuDisplay}</td>
                        <td>${productName}</td>
                        <td><span class="badge ${changeInfo.badgeClass}">${changeInfo.label}</span></td>
                        <td>${flaggedBy}</td>
                        <td>${comment}</td>
                    </tr>
                `;
            }).join('');
            
            return `
                <div style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-striped table-hover mb-0 warehouse-table">
                        <thead class="table-light position-sticky top-0">
                            <tr>
                                <th class="text-center">PO ID</th>
                                <th class="text-center">Order ID</th>
                                <th class="text-center">SKU</th>
                                <th>Item</th>
                                <th>Change Log</th>
                                <th>Flagged By</th>
                                <th>Comment</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rows}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function attachWarehouseRowHandlers() {
            document.querySelectorAll('.warehouse-review-row').forEach(row => {
                row.addEventListener('click', () => {
                    const reviewData = row.getAttribute('data-review');
                    if (!reviewData) return;
                    try {
                        const review = JSON.parse(decodeURIComponent(reviewData));
                        openWarehouseReviewModal(review);
                    } catch (error) {
                        console.error('Failed to parse review data for modal', error);
                    }
                });
            });
        }

        let warehouseModalInstance = null;
        let currentWarehouseReview = null;

        function ensureWarehouseModal() {
            if (warehouseModalInstance || typeof bootstrap === 'undefined') return;
            const modalEl = document.getElementById('warehouseReviewModal');
            if (modalEl) {
                warehouseModalInstance = new bootstrap.Modal(modalEl);
                const closeBtn = document.getElementById('warehouseCloseBtn');
                if (closeBtn) {
                    closeBtn.addEventListener('click', submitWarehouseClose);
                }
                modalEl.addEventListener('hidden.bs.modal', () => {
                    currentWarehouseReview = null;
                    document.getElementById('warehouseCommentInput').value = '';
                    toggleWarehouseModalLoading(false);
                    showWarehouseModalWarning(null);
                });
            }
        }

        function openWarehouseReviewModal(review) {
            ensureWarehouseModal();
            if (!warehouseModalInstance) return;
            currentWarehouseReview = review;
            populateWarehouseModal(review);
            warehouseModalInstance.show();
        }

        function populateWarehouseModal(review) {
            document.getElementById('warehouseDetailPoId').textContent = review.po_id || '-';
            if (review.order_id) {
                document.getElementById('warehouseDetailOrderId').innerHTML = `<a href="https://www.chainsawspares.com.au/_cpanel/order/vieworder?id=${review.order_id}" target="_blank">${review.order_id}</a>`;
            } else {
                document.getElementById('warehouseDetailOrderId').textContent = '-';
            }
            document.getElementById('warehouseDetailItemId').textContent = review.po_item_id || '-';
            document.getElementById('warehouseDetailSku').textContent = review.sku || '-';
            document.getElementById('warehouseDetailProduct').textContent = getReviewProductName(review);
            const changeInfo = getChangeLogDisplay(getReviewChangeLog(review));
            document.getElementById('warehouseDetailChange').innerHTML = `<span class="badge ${changeInfo.badgeClass}">${changeInfo.label}</span>`;
            document.getElementById('warehouseDetailFlaggedBy').textContent = review.flagged_by || '-';
            document.getElementById('warehouseDetailFlaggedAt').textContent = formatLocalDateTime(review.flagged_at);
            document.getElementById('warehouseDetailRetailComment').textContent = review.flag_comment || '';
            const snapshot = getReviewSnapshot(review);
            document.getElementById('warehouseDetailLatestNote').textContent = snapshot && snapshot.latest_item_note ? `${snapshot.latest_item_note_user || 'User'}: ${snapshot.latest_item_note}` : '';
            renderReviewStatGrid(snapshot, 'warehouseDetailStats');
            document.getElementById('warehouseCommentInput').value = review.warehouse_comment || '';
            showWarehouseModalWarning(null);
        }

        function renderReviewStatGrid(snapshot, targetElementId) {
            const grid = document.getElementById(targetElementId);
            if (!grid) return;
            if (!snapshot) {
                grid.innerHTML = '<div class="text-muted">No snapshot data available.</div>';
                return;
            }
            const stats = [
                { label: 'REX Qty Available', value: snapshot.rex_available_qty },
                { label: 'NETO Qty Available', value: snapshot.neto_qty_available },
                { label: 'Original REX Qty Ordered', value: snapshot.original_rex_qty_ordered },
                { label: 'NETO Qty Invoiced', value: snapshot.neto_qty_shipped },
                { label: 'REX Qty Received', value: snapshot.rex_qty_received },
                { label: 'Disparity', value: snapshot.disparity ? 'Yes' : 'No' }
            ];
            grid.innerHTML = stats.map(stat => `
                <div class="stat-card">
                    <div class="text-muted" style="font-size:0.8rem;">${stat.label}</div>
                    <div class="fw-bold" style="font-size:1.1rem;">${stat.value ?? '-'}</div>
                </div>
            `).join('');
        }

        function toggleWarehouseModalLoading(isLoading) {
            const btn = document.getElementById('warehouseCloseBtn');
            if (!btn) return;
            const defaultLabel = btn.querySelector('.default-label');
            const loadingLabel = btn.querySelector('.loading-label');
            btn.disabled = isLoading;
            if (defaultLabel && loadingLabel) {
                if (isLoading) {
                    defaultLabel.classList.add('d-none');
                    loadingLabel.classList.remove('d-none');
                } else {
                    defaultLabel.classList.remove('d-none');
                    loadingLabel.classList.add('d-none');
                }
            }
        }

        function showWarehouseModalWarning(message) {
            const warning = document.getElementById('warehouseDetailWarning');
            if (!warning) return;
            if (message) {
                warning.classList.remove('d-none');
                warning.textContent = message;
            } else {
                warning.classList.add('d-none');
                warning.textContent = '';
            }
        }

        function submitWarehouseClose() {
            if (!currentWarehouseReview) return;
            const commentInput = document.getElementById('warehouseCommentInput');
            const comment = commentInput ? commentInput.value.trim() : '';
            if (!comment) {
                showWarehouseModalWarning('Please enter a comment before closing the review.');
                return;
            }
            toggleWarehouseModalLoading(true);
            showWarehouseModalWarning(null);
            fetch(`/api/reviews/${currentWarehouseReview.review_id}/close`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ comment })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    warehouseModalInstance.hide();
                    fetchWarehouseReviews();
                } else {
                    showWarehouseModalWarning(data.error || 'Failed to update review.');
                }
            })
            .catch(error => {
                showWarehouseModalWarning(error.message || 'Failed to update review.');
            })
            .finally(() => {
                toggleWarehouseModalLoading(false);
            });
        }
    </script>
    {% block scripts %}{% endblock %}
    
    <!-- Version Footer -->
    <div style="position: fixed; bottom: 10px; right: 20px; font-size: 0.75rem; color: #95a5a6; z-index: 1000;">
        v2.0 - Production Ready! 
    </div>
</body>
</html>
